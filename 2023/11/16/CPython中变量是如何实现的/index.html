



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="神的直觉" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="神的直觉" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="神的直觉" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="CPython,C" />


<link rel="canonical" href="http://example.com/2023/11/16/CPython%E4%B8%AD%E5%8F%98%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">



  <title>
CPython中变量是如何实现的 - C - CPython |
Waim Chiu = 神的直觉</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">CPython中变量是如何实现的
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-11-16 16:57:44">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-11-16T16:57:44+08:00">2023-11-16</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Waim Chiu</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?342385"></li>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?768125"></li>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?280163"></li>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?723486"></li>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?110782"></li>
          <li class="item" data-background-image="https://tuapi.eees.cc/api.php?category=dongman&type=302&?148219"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CPython/" itemprop="item" rel="index" title="In CPython"><span itemprop="name">CPython</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CPython/C/" itemprop="item" rel="index" title="In C"><span itemprop="name">C</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/16/CPython%E4%B8%AD%E5%8F%98%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.png">
    <meta itemprop="name" content="小芳芳">
    <meta itemprop="description" content=", 又战斗来又生产">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="神的直觉">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h3 id="初步了解"><a class="markdownIt-Anchor" href="#初步了解">#</a> 初步了解</h3>
<p>一条简单的赋值语句</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> b</pre></td></tr></table></figure><p>我们所做的就是将 b 分配给 a，那么这会引出什么问题</p>
<ul>
<li>名称与值关联意味着什么，什么是值</li>
<li>CPython 如何为名称赋值，怎么获取值</li>
<li>所有变量都以相同的方式实现吗</li>
</ul>
<p>为了运行 Python 代码，CPython 会将其编译为字节码 (byte code)，所以我们首先来看看编译后的字节码</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span><span class="token string">"a = b"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> STORE_NAME               <span class="token number">1</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">4</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token number">6</span> RETURN_VALUE</pre></td></tr></table></figure><p>CPython VM 使用值堆栈进行操作。从堆栈中弹出值，对它们执行某些操作，然后将计算结果推回堆栈。LOAD_NAME 和 STORE_NAME 最典型</p>
<ul>
<li>LOAD_NAME: 获取名称的值 b, 并将其压入堆栈</li>
<li>STORE_NAME: 从堆栈中弹出值，并将名称 a 与该值关联起来</li>
</ul>
<p>CPython 中所有操作码都是在一个巨大的 switch 语句中实现的，因此我们可以在其中了解 LOAD_NAME 或 STORE_NAME 是如何工作的</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>STORE_NAME<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>ns <span class="token operator">=</span> f<span class="token operator">-></span>f_locals<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ns <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">_PyErr_Format</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_SystemError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                      <span class="token string">"no locals found when storing %R"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyDict_CheckExact</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        err <span class="token operator">=</span> <span class="token function">PyDict_SetItem</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> name<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        err <span class="token operator">=</span> <span class="token function">PyObject_SetItem</span><span class="token punctuation">(</span>ns<span class="token punctuation">,</span> name<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li>名称是一个字符串，它们存储在名为 co_names 元组对象中，STORE_NAME 指令的参数不是名称，而是用于在 co_names 中查找名称的索引。VM 第一件事就是从中获取名称，并为其分配值</li>
<li>VM 从堆栈中弹出该值</li>
<li>变量的值存储在 frame 对象中，frame 对象的 f_locals 就是局部变量，存储着它们的名称和值。VM 通过将名称与值关联起来。f_locals [name] = v</li>
</ol>
<p>我们了解到</p>
<ul>
<li>Python 变量是映射到值的名称</li>
<li>名称的值是对 Python 对象的引用</li>
</ul>
<p>LOAD_NAME 有点复杂，因为 VM 不仅在 f_locals 其中查找名称的值，还会在其它地方查找名称的值</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>LOAD_NAME<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>locals <span class="token operator">=</span> f<span class="token operator">-></span>f_locals<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>v<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>locals <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">_PyErr_Format</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_SystemError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                      <span class="token string">"no locals when loading %R"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyDict_CheckExact</span><span class="token punctuation">(</span>locals<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        v <span class="token operator">=</span> <span class="token function">PyDict_GetItemWithError</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span> </pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_PyErr_Occurred</span><span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        v <span class="token operator">=</span> <span class="token function">PyObject_GetItem</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_PyErr_ExceptionMatches</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_KeyError<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token function">_PyErr_Clear</span><span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        v <span class="token operator">=</span> <span class="token function">PyDict_GetItemWithError</span><span class="token punctuation">(</span>f<span class="token operator">-></span>f_globals<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_PyErr_Occurred</span><span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyDict_CheckExact</span><span class="token punctuation">(</span>f<span class="token operator">-></span>f_builtins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                v <span class="token operator">=</span> <span class="token function">PyDict_GetItemWithError</span><span class="token punctuation">(</span>f<span class="token operator">-></span>f_builtins<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_PyErr_Occurred</span><span class="token punctuation">(</span>tstate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token function">format_exc_check_arg</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                                tstate<span class="token punctuation">,</span> PyExc_NameError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                                NAME_ERROR_MSG<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                v <span class="token operator">=</span> <span class="token function">PyObject_GetItem</span><span class="token punctuation">(</span>f<span class="token operator">-></span>f_builtins<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_PyErr_ExceptionMatches</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> PyExc_KeyError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token function">format_exc_check_arg</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                                    tstate<span class="token punctuation">,</span> PyExc_NameError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                                    NAME_ERROR_MSG<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token function">PUSH</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol>
<li>对于 STORE_NAME 操作码，VM 首先获取变量的名称</li>
<li>VM 在局部变量的映射中查找名称的值: v = f_locals [name]</li>
<li>如果该名称不在 f_locals, VM 将在全局字典 f_globals 中查找该值，如果名称也不在 f_globals, 那么 VM 还会在 f_builtins 中查找，f_builtins 指向 builtins 模块的字典，其中包含内置类型、函数、异常和变量。如果该名称还不存在，则会放弃查找并抛出 NameError</li>
<li>如果 VM 找到该值，则将该值压入堆栈</li>
</ol>
<p>VM 搜索值的方式具体有以下影响</p>
<ul>
<li>我们经常使用到 builtin 字典中的 int、next、ValueError 和 None 等</li>
<li>如果我们对局部变量或全局变量使用内置名称，那么新变量将会覆盖内置变量</li>
<li>局部变量会隐藏同名的全局变量</li>
</ul>
<p>由于我们需要对变量做的就是将它们与值关联并获取它们的值，因此，可以认为 STORE_NAME 和 LOAD_NAME 足以实现 Python 中的所有变量。</p>
<p>下面这个例子</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>x <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">return</span> z</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">return</span> x <span class="token operator">+</span> y <span class="token operator">+</span> z</pre></td></tr></table></figure><p>该 f 函数必须加载变量 x、y, 并将与 z 相加返回结果</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">7</span>          <span class="token number">12</span> LOAD_GLOBAL              <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>           <span class="token number">14</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>           <span class="token number">16</span> BINARY_ADD</pre></td></tr><tr><td data-num="5"></td><td><pre>           <span class="token number">18</span> LOAD_DEREF               <span class="token number">0</span> <span class="token punctuation">(</span>z<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>           <span class="token number">20</span> BINARY_ADD</pre></td></tr><tr><td data-num="7"></td><td><pre>           <span class="token number">22</span> RETURN_VALUE</pre></td></tr></table></figure><p>可以看到，没有 LOAD_NAME 操作码，编译器生成 LOAD_GLOBAL 操作码加载 x, LOAD_FAST 加载 y, LOAD_DEREF 加载 z。为什么会产生不同的操作码，这里有两个重要的概念：命名空间和作用域</p>
<h3 id="命名空间和范围"><a class="markdownIt-Anchor" href="#命名空间和范围">#</a> 命名空间和范围</h3>
<p>Python 程序由代码块组成，代码块是 VM 作为单元执行的一段代码，CPython 区分三种类型的代码块</p>
<ul>
<li>模块</li>
<li>函数（推导式和 lambda 也是函数）</li>
<li>类定义</li>
</ul>
<p>编译器为程序中的每个代码块创建一个 CodeObject, 它是描述代码块功能的结构，它包含块的字节码。为了执行代码对象，CPython 为其创建一个称为 FrameObject 的执行状态。除此之外，FrameObject 对象还包含 key-value 映射，如 f_locals、f_globals 和 f_builtins。这些映射称位名称空间。每个代码块都会引入一个名称空间，程序中相同名称可能引用不同命名空间中的不同变量</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>x <span class="token operator">=</span> y <span class="token operator">=</span> <span class="token string">"I'm a variable in a global namespace"</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  x <span class="token operator">=</span> <span class="token string">"I'm a local variable"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> I<span class="token string">'m a variable in a global namespace</pre></td></tr><tr><td data-num="2"></td><td><pre>>>> I'</span>m a variable <span class="token keyword">in</span> a global namespace</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> I<span class="token string">'m a local variable</pre></td></tr><tr><td data-num="4"></td><td><pre>>>> I'</span>m a variable <span class="token keyword">in</span> a global namespace</pre></td></tr></table></figure><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>a <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  b <span class="token operator">=</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">return</span> a <span class="token operator">+</span> b</pre></td></tr></table></figure><p>这里名称 a 在两种情况下都指向相同的变量，从函数的角度看，它是一个全局变量，但从模块的角度看，它既是全局变量，又是局部变量。变量 b 是 f 函数的本地变量，它不存在于模块级别</p>
<p>如果该变量绑定在代码块中，则该变量视为代码块的本地变量，像这种赋值语句 a = 1 将名称 a 绑定到 1。然而，赋值语句并不是唯一绑定名称的唯一方法。Python 文档<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9yZWZlcmVuY2UvZXhlY3V0aW9ubW9kZWwuaHRtbCNuYW1pbmctYW5kLWJpbmRpbmc=">列出更多内容</span></p>
<p>由于名称的任何绑定都会让编译器认为该名称是本地名称，因此以下代码会抛异常</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>a <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  a <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">return</span> a</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ python unbound_local.py</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre>    a <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>UnboundLocalError: <span class="token builtin class-name">local</span> variable <span class="token string">'a'</span> referenced before assignment</pre></td></tr></table></figure><p>该 a += 1 语句是一种赋值形式，因此编译器认为 a 是局部的，为了执行该操作，VM 尝试加载 a 值，结果失败了并设置异常，为了告诉编译器 a 是有赋值，但它是全局的，所以我们应该使用 global 语句，告诉编译器，你应该从 globals 开始找</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>a <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">global</span> a</pre></td></tr><tr><td data-num="5"></td><td><pre>  a <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">return</span> a</pre></td></tr></table></figure><p>同样，我们可以使用 nonlocal 语句告诉编译器，内嵌函数中绑定的名称引用上层函数中的变量</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>a <span class="token operator">=</span> <span class="token string">"I'm not used"</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">nonlocal</span> a</pre></td></tr><tr><td data-num="6"></td><td><pre>    a <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  a <span class="token operator">=</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  inner<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>这是编译器的工作，用于分析代码块中名称的使用情况，考虑如 global 和 nonlocal 之类的语句，并生成正确的操作码来加载和存储值。编译器为名称生成哪个操作码取决于该名称的范围以及当前正在编译的代码块的类型。VM 以不同的方式执行不同的操作码，所有这些都是为了让 Python 变量按照它们的方式工作</p>
<p>CPython 总共使用四对加载 / 存储操作码和一对加载操作码</p>
<ul>
<li>LOAD_FAST 和 STORE_FAST</li>
<li>LOAD_DEREF 和 STORE_DEREF</li>
<li>LOAD_GLOBAL 和 STORE_GLOBAL</li>
<li>LOAD_NAME 和 STORE_NAME</li>
<li>LOAD_CLASSDEREF</li>
</ul>
<h3 id="load_fast和store_fast"><a class="markdownIt-Anchor" href="#load_fast和store_fast">#</a> LOAD_FAST 和 STORE_FAST</h3>
<p>编译器为函数的局部变量生成 LOAD_FAST 和 STORE_FAST</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  y <span class="token operator">=</span> x</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">return</span> y</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">2</span>           <span class="token number">0</span> LOAD_FAST                <span class="token number">0</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> STORE_FAST               <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token number">3</span>           <span class="token number">4</span> LOAD_FAST                <span class="token number">1</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token number">6</span> RETURN_VALUE</pre></td></tr></table></figure><p>该 y 是本地变量，因为它是由 f 函数内赋值绑定的，x 为本地变量，因为它作为其参数绑定</p>
<p>来看看 STORE_FAST 的代码</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>STORE_FAST<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">PREDICTED</span><span class="token punctuation">(</span>STORE_FAST<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>value <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function">SETLOCAL</span><span class="token punctuation">(</span>oparg<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">FAST_DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>SETLOCAL 是一个宏定义: fastlocals [oparg] = value, fastlocals 只是 FrameObject 中 f_localsplus 字段的简写。该字段是一个指向 Python 对象的指针数组。它存储局部变量、单元变量、自由变量和值堆栈的值。</p>
<p>在操作码为 STORE_NAME 时，VM 首先从 co_names 中获取名称，然后将该名称映射到堆栈顶部的值。它用作 f_locals 名称 - 值的映射，通常是字典。对于 STORE_FAST 操作码，VM 不需要获取名称。局部变量的数量可以由编译器静态计算，因此 VM 可以使用数组来存储它们的值。每个局部变量都可以与该数组的索引相关联。为了将名称映射到值，VM 只需将值存储在相应的索引中即可</p>
<h3 id="load_deref和store_deref"><a class="markdownIt-Anchor" href="#load_deref和store_deref">#</a> LOAD_DEREF 和 STORE_DEREF</h3>
<p>在一种情况下，编译器不会为函数的本地变量生成 LOAD_FAST 和 STORE_FAST, 当在嵌套函数中使用变量时会发生这种情况</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  b <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> b</pre></td></tr></table></figure><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Disassembly of <span class="token operator">&lt;</span>code object f at 0x1027c72f0, <span class="token function">file</span> <span class="token string">"nested.py"</span>, line <span class="token operator"><span class="token file-descriptor important">1</span>></span>:</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">2</span>           <span class="token number">0</span> LOAD_CONST               <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">2</span> STORE_DEREF              <span class="token number">0</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">3</span>           <span class="token number">4</span> LOAD_CLOSURE             <span class="token number">0</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token number">6</span> BUILD_TUPLE              <span class="token number">1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token number">8</span> LOAD_CONST               <span class="token number">2</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>code object g at 0x1027c7240, <span class="token function">file</span> <span class="token string">"nested.py"</span>, line <span class="token operator"><span class="token file-descriptor important">3</span>></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>           <span class="token number">10</span> LOAD_CONST               <span class="token number">3</span> <span class="token punctuation">(</span><span class="token string">'f.&lt;locals>.g'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>           <span class="token number">12</span> MAKE_FUNCTION            <span class="token number">8</span> <span class="token punctuation">(</span>closure<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>           <span class="token number">14</span> STORE_FAST               <span class="token number">0</span> <span class="token punctuation">(</span>g<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>           <span class="token number">16</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span>None<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>           <span class="token number">18</span> RETURN_VALUE</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>Disassembly of <span class="token operator">&lt;</span>code object g at 0x1027c7240, <span class="token function">file</span> <span class="token string">"nested.py"</span>, line <span class="token operator"><span class="token file-descriptor important">3</span>></span>:</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token number">4</span>           <span class="token number">0</span> LOAD_DEREF               <span class="token number">0</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token number">2</span> RETURN_VALUE</pre></td></tr></table></figure><p>编译器为单元变量和自由变量生成 LOAD_REDEF 和 STORE_DEREF 操作码。单元变量是嵌套函数中引用的变量。在上述代码中，b 是函数 f 的单元变量，因为它被 g 引用。从嵌套函数的角度来看，自由变量是单元变量。它是一个未绑定在嵌套函数中但在封闭函数。在代码中，b 是函数 g 的自由变量，因为它没有绑定在 g 中，而是绑定在 f 中</p>
<p>单元变量和自由变量的值存储在 f_localsplus 数组中，唯一的区别是，f_localsplus [index_of_cell_or_free_variable] 不是直接指向该值，而是指向包含该值的单元格对象</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject_HEAD</pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>ob_ref<span class="token punctuation">;</span>       <span class="token comment">/* Content of the cell or NULL when empty */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span> PyCellObject<span class="token punctuation">;</span></pre></td></tr></table></figure><p>STORE_DEREF 操作码从堆栈中弹出值，获取 oparg 指定的变量的单元格，并将该单元格的 ob_ref 分配给弹出的值</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>STORE_DEREF<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>cell <span class="token operator">=</span> freevars<span class="token punctuation">[</span>oparg<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>oldobj <span class="token operator">=</span> <span class="token function">PyCell_GET</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">PyCell_SET</span><span class="token punctuation">(</span>cell<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>oldobj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>LOAD_DEREF 操作码的工作原理是将单元格的内容推入堆栈</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>LOAD_DEREF<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>cell <span class="token operator">=</span> freevars<span class="token punctuation">[</span>oparg<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>value <span class="token operator">=</span> <span class="token function">PyCell_GET</span><span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token function">format_exc_unbound</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> co<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">PUSH</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在单元格中存储值是什么原因？这样做是为了将自由变量与相应单元变量连接起来。它们的值存储在不同框架对象的不同命名空间中，但存储在同一单元格中。VM 在创建封闭函数时将封闭函数的单元格传递给封闭函数。LOAD_CLOSURE 操作码将一个单元推入堆栈，MAKE_FUNCTION 操作码使用该单元为相应的自由变量创建一个函数对象。由于单元机制，当封闭函数重新分配单元变量时，封闭函数会看到重新分配</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    a <span class="token operator">=</span> <span class="token string">'assigned'</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    g<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    a <span class="token operator">=</span> <span class="token string">'reassigned'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    g<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>$ python cell_reassign<span class="token punctuation">.</span>py </pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> assigned</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> reassigned</pre></td></tr></table></figure><p>反之亦然</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">nonlocal</span> a</pre></td></tr><tr><td data-num="4"></td><td><pre>        a <span class="token operator">=</span> <span class="token string">'reassigned'</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    a <span class="token operator">=</span> <span class="token string">'assigned'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    g<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>$ python free_reassign<span class="token punctuation">.</span>py </pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> assigned</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> reassigned</pre></td></tr></table></figure><p>当我们调用函数时，CPython 会创建一个 FrameObject 来执行它，单元机制的好处是它允许避免将封闭函数的 FrameObject 及其所有引用保留在内存中。</p>
<h3 id="load_global和store_global"><a class="markdownIt-Anchor" href="#load_global和store_global">#</a> LOAD_GLOBAL 和 STORE_GLOBAL</h3>
<p>编译器为函数中的全局变量生成 LOAD_GLOBAL 和 STORE_GLOBAL 操作码。如果变量被 global 声明或者未绑定在函数和任何封闭函数内（它既不是本地变量也不是自由变量），则该变量被认为是函数中的全局变量。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>a <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre>d <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    b <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">global</span> d</pre></td></tr><tr><td data-num="8"></td><td><pre>        c <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        d <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c <span class="token operator">+</span> d</pre></td></tr></table></figure><p>变量 c 不是全局变量，因为它是 g 函数的本地变量。变量 b 不是全局变量，因为它是自由变量。变量 a 是全局变量，因为它既不是本地变量也不是自由变量。并且变量 d 是全局的，因为它显式的声明了 global</p>
<p>这时 STORE_GLOBAL 操作码的实现</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>STORE_GLOBAL<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    err <span class="token operator">=</span> <span class="token function">PyDict_SetItem</span><span class="token punctuation">(</span>f<span class="token operator">-></span>f_globals<span class="token punctuation">,</span> name<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>f_globals 字段是 FrameObject 的一個字典，它將全局名稱映射到它們的值。儅 CPython 為模塊創建 FrameObject 時，它會分配 g_globals 字典分配給模塊</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ python <span class="token parameter variable">-q</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sys</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> globals<span class="token punctuation">(</span><span class="token punctuation">)</span> is sys.modules<span class="token punctuation">[</span><span class="token string">'__main__'</span><span class="token punctuation">]</span>.__dict__</pre></td></tr><tr><td data-num="4"></td><td><pre>True</pre></td></tr></table></figure><p>当 VM 执行 MAKE_FUNCTION 操作码来创建新的函数对象时，它将该对象的 func_globals 字段分配给当前帧对象的 f_globals。当函数被调用时，VM 会为其创建一个新的框架对象，并将 f_globals 设置为 func_globals</p>
<p>LOAD_GLOBAL 的实现和 LOAD_NAME 的实现类似，但有两个例外:</p>
<ul>
<li>它不会查找 f_locals 中的值</li>
<li>它使用缓存来减少查找时间</li>
</ul>
<p>CPython 将结果缓存在 co_opcache 数组中的代码对象中。该数组存储指向_PyOpcache 结构的指针</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>ptr<span class="token punctuation">;</span>  <span class="token comment">/* Cached pointer (borrowed reference) */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">uint64_t</span> globals_ver<span class="token punctuation">;</span>  <span class="token comment">/* ma_version of global dict */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">uint64_t</span> builtins_ver<span class="token punctuation">;</span> <span class="token comment">/* ma_version of builtin dict */</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span> _PyOpcache_LoadGlobal<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_PyOpcache</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        _PyOpcache_LoadGlobal lg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span> u<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">char</span> optimized<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>_PyOpcache_LoadGlobal 结构体的 ptr 字段指向 LOAD_GLOBAL 的实际结果。高速缓存按指令号维护。代码对象中的另一个数组称为 co_opcache_map，将字节码中的每条指令映射到其在 co_opcache 中的索引减一。如果指令不是 LOAD_GLOBAL，它会将该指令映射为 0，这意味着该指令永远不会被缓存。缓存的大小不会超过 254。如果字节码包含超过 254 条 LOAD_GLOBAL 指令，co_cocache_map 也会将多余的指令映射到 0</p>
<p>如果 VM 在执行 LOAD_GLOBAL 时在缓存中找到一个值，它会确保自上次查找该值以来 f_global 和 f_builtins 字典没有被修改。这是通过将 global_ver 和 builtins_ver 与字典的 ma_version_tag 进行比较来完成的。每次修改字典时，字典的 ma_version_tag 字典都会更改。更多详细信息，请参阅 <span class="exturl" data-url="aHR0cHM6Ly9wZXBzLnB5dGhvbi5vcmcvcGVwLTA1MDkv">PEP 509</span></p>
<p>如果 VM 在缓存中没有找到值，它会首先在 f_globals 中进行正常查找，然后在 f_builtins 中进行查找。如果它最终找到了一个值，它会记住两个字典的当前 ma_version_tag 并将该值推入堆栈。</p>
<h3 id="load_name和store_name-and-load_classderef"><a class="markdownIt-Anchor" href="#load_name和store_name-and-load_classderef">#</a> LOAD_NAME 和 STORE_NAME (and LOAD_CLASSDEREF)</h3>
<p>编译器为类定义创建代码对象，就像为模块和函数创建代码对象一样。有趣的是，编译器几乎总是为类体内的变量生成 LOAD_NAME 和 STORE_NAME 操作码。此规则有两个罕见的例外：自由变量和显式声明为全局的变量</p>
<p>VM 以不同的方式执行 *_NAME 和 *_FAST 操作码。因此，变量在类主体中的工作方式与函数中的工作方式不同</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"This code is executed"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>$ python class_local<span class="token punctuation">.</span>py</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">global</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> local</pre></td></tr></table></figure><p>第一次加载时，VM 从 f_globals 加载 x 变量的值，然后它将新值存储在 f_locals 中，并在第二次加载时从那里加载它。如果它是一个函数，那么当我们调用它时，我们会得到 UnboundLocalError: local variable ‘x’ referenced before assignment when we call it，因为编译器认为 x 变量是 C 的局部变量</p>
<p>类和函数的命名空间如何相互作用？当我们将函数放入类中，该函数看不到绑定在类名称空间中的名称</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">D</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    x <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">method</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>D<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>method<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>$ python func_in_class<span class="token punctuation">.</span>py</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> NameError<span class="token punctuation">:</span> name <span class="token string">'x'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined</pre></td></tr></table></figure><p>这是因为 VM 在执行类定义时使用 STORE_NAME 存储 x 的值，并在执行函数时尝试使用 LOAD_GLOBAL 加载它。然而，当我们将类定义中放入函数时，单元机制的工作方式就像将函数放入函数中一样</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    x <span class="token operator">=</span> <span class="token string">"I'm a cell variable"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>$ python class_in_func<span class="token punctuation">.</span>py </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> I'm a cell variable</pre></td></tr></table></figure><p>但还是有区别的。编译器生成 LOAD_CLASSDEREF 操作码而不是 LOAD_DEREF 来加载 x 的值，dis 模块有解释<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L2Rpcy5odG1sI29wY29kZS1MT0FEX0NMQVNTREVSRUY="> LOAD_CLASSDEREF</span> 的作用</p>
<p>与 LOAD_DEREF 非常类似，但在查询单元格之前首先检查本地字典。这用于在类中加载自由变量</p>
<p>那么，为什么它首先检查 locals 字典？对于函数，编译器可以确定变量是否为本地变量。对于类，编译器无法确定。这是因为 CPython 有元类，元类可以通过实现<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9yZWZlcmVuY2UvZGF0YW1vZGVsLmh0bWwjcHJlcGFyaW5nLXRoZS1jbGFzcy1uYW1lc3BhY2U=">__prepare__</span>方法为类准备一个非空的局部字典</p>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结">#</a> 总结</h3>
<p>确定变量的范围</p>
<ol>
<li>如果变量声明为全局变量，则它是显式全局变量</li>
<li>如果变量声明为局部变量，则它是自由变量</li>
<li>如果变量绑定在当前代码块内，则它是局部变量</li>
<li>如果变量绑定在不是类定义的封闭代码块中，则它是自由变量。否则，它是一个隐式全局变量</li>
</ol>
<p>更新范围</p>
<ol>
<li>如果变量是本地变量并且在封闭的代码块中是空闲的，则它是单元格变量</li>
</ol>
<p>决定生成哪个操作码</p>
<ol>
<li>如果变量是单元变量或自由变量，则产生 *_DEREF 操作码；如果当前代码块是类定义，则生成 LOAD_CLASSDEREF 操作码来加载值</li>
<li>如果变量是局部变量并且当前代码块是函数，则生成 *_FAST 操作码</li>
<li>如果变量是显式全局变量或者隐式全局变量并且当前代码块是函数，则生成 *_GLOBAL 操作码，否在，生成 *_NAME 操作码</li>
</ol>

      <div class="tags">
          <a href="/tags/CPython/" rel="tag"><i class="ic i-tag"></i> CPython</a>
          <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-04-11 20:27:22" itemprop="dateModified" datetime="2024-04-11T20:27:22+08:00">2024-04-11</time>
  </span>
  <span id="2023/11/16/CPython中变量是如何实现的/" class="item leancloud_visitors" data-flag-title="CPython中变量是如何实现的" title="Views">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">Views</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">times</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="小芳芳 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="小芳芳 Alipay">
        <p>Alipay</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>石理一淡 <i class="ic i-at"><em>@</em></i>神的直觉
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/11/16/CPython%E4%B8%AD%E5%8F%98%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/" title="CPython中变量是如何实现的">http://example.com/2023/11/16/CPython中变量是如何实现的/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/09/21/MySQL-InnoDB%E7%9A%84MVCC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tuapi.eees.cc&#x2F;api.php?category&#x3D;dongman&amp;type&#x3D;302&amp;?368313" title="MySQL InnoDB的MVCC实现原理">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> MySQL</span>
  <h3>MySQL InnoDB的MVCC实现原理</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/06/13/Django%E5%85%AC%E4%BC%97%E5%8F%B7%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E9%98%B2%E8%B8%A9%E5%B1%8E/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tuapi.eees.cc&#x2F;api.php?category&#x3D;dongman&amp;type&#x3D;302&amp;?343013" title="Django公众号对接微信支付防踩屎">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> C</span>
  <h3>Django公众号对接微信支付防踩屎</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E4%BA%86%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text"> 初步了解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C%E8%8C%83%E5%9B%B4"><span class="toc-number">2.</span> <span class="toc-text"> 命名空间和范围</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load_fast%E5%92%8Cstore_fast"><span class="toc-number">3.</span> <span class="toc-text"> LOAD_FAST 和 STORE_FAST</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load_deref%E5%92%8Cstore_deref"><span class="toc-number">4.</span> <span class="toc-text"> LOAD_DEREF 和 STORE_DEREF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load_global%E5%92%8Cstore_global"><span class="toc-number">5.</span> <span class="toc-text"> LOAD_GLOBAL 和 STORE_GLOBAL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#load_name%E5%92%8Cstore_name-and-load_classderef"><span class="toc-number">6.</span> <span class="toc-text"> LOAD_NAME 和 STORE_NAME (and LOAD_CLASSDEREF)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.</span> <span class="toc-text"> 总结</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/06/06/%E5%93%AA%E4%BA%9BPython%E6%93%8D%E4%BD%9C%E6%98%AFatomic%E7%9A%84%EF%BC%9F/" rel="bookmark" title="哪些Python操作是atomic的？">哪些Python操作是atomic的？</a></li><li><a href="/2022/06/08/Python%E5%86%85%E7%BD%AEgetattr%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="getattr實現原理">getattr實現原理</a></li><li><a href="/2022/06/13/Python%20tuple%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python Tuple實現原理">Python Tuple實現原理</a></li><li><a href="/2022/06/22/Python%20range%E7%9A%84%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python range的實現原理">Python range的實現原理</a></li><li><a href="/2022/06/23/CPython-VM%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" rel="bookmark" title="CPython VM的工作原理">CPython VM的工作原理</a></li><li><a href="/2022/06/28/Python%20map%E5%AF%B9%E8%B1%A1%E6%8E%A2%E7%A9%B6/" rel="bookmark" title="Python map对象探究">Python map对象探究</a></li><li><a href="/2022/07/06/Python%20zip%E5%86%85%E7%BD%AE%E7%B1%BB%E7%9A%84%E8%83%8C%E5%90%8E%E6%9C%BA%E5%88%B6/" rel="bookmark" title="Python zip内置类的背后机制">Python zip内置类的背后机制</a></li><li><a href="/2022/08/03/Python%20list%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python list实现原理">Python list实现原理</a></li><li><a href="/2022/08/12/Python%20Property%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="bookmark" title="Property源码分析">Property源码分析</a></li><li><a href="/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/" rel="bookmark" title="Python的属性是如何工作的">Python的属性是如何工作的</a></li><li><a href="/2023/08/14/Python%20import%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="bookmark" title="Python import源码分析">Python import源码分析</a></li><li class="active"><a href="/2023/11/16/CPython%E4%B8%AD%E5%8F%98%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84/" rel="bookmark" title="CPython中变量是如何实现的">CPython中变量是如何实现的</a></li><li><a href="/2024/06/13/Django%E5%85%AC%E4%BC%97%E5%8F%B7%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E9%98%B2%E8%B8%A9%E5%B1%8E/" rel="bookmark" title="Django公众号对接微信支付防踩屎">Django公众号对接微信支付防踩屎</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="小芳芳"
      data-src="/images/avatar.png">
  <p class="name" itemprop="name">小芳芳</p>
  <div class="description" itemprop="description">又战斗来又生产</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">34</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">18</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">20</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NMQVktemhhbw==" title="https:&#x2F;&#x2F;github.com&#x2F;CLAY-zhao"><i class="ic i-github"></i></span>
      <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjkxMzUwNTA=" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;29135050"><i class="ic i-bilibili"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTEyMzkzMjE0MA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;123932140"><i class="ic i-cloud-music"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于我</a>
  </li>

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>文章</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分類</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>標簽</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友鏈</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>網址</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/09/21/MySQL-InnoDB%E7%9A%84MVCC%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/06/13/Django%E5%85%AC%E4%BC%97%E5%8F%B7%E5%AF%B9%E6%8E%A5%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E9%98%B2%E8%B8%A9%E5%B1%8E/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/06/28/Python%20map%E5%AF%B9%E8%B1%A1%E6%8E%A2%E7%A9%B6/" title="Python map对象探究">Python map对象探究</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython-C/" title="In CPython C">CPython C</a>
</div>

    <span><a href="/2023/02/17/Inside-The-Python-Virtual-Machine-Code-Objects/" title="Inside-The-Python-Virtual-Machine-Code Objects">Inside-The-Python-Virtual-Machine-Code Objects</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/07/06/Python%20zip%E5%86%85%E7%BD%AE%E7%B1%BB%E7%9A%84%E8%83%8C%E5%90%8E%E6%9C%BA%E5%88%B6/" title="Python zip内置类的背后机制">Python zip内置类的背后机制</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Linux-Kubernetes/" title="In Linux Kubernetes">Linux Kubernetes</a>
</div>

    <span><a href="/2023/02/03/k8s-Statefulset%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8/" title="k8s Statefulset有状态应用">k8s Statefulset有状态应用</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/08/03/Python%20list%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" title="Python list实现原理">Python list实现原理</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/06/06/%E5%93%AA%E4%BA%9BPython%E6%93%8D%E4%BD%9C%E6%98%AFatomic%E7%9A%84%EF%BC%9F/" title="哪些Python操作是atomic的？">哪些Python操作是atomic的？</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/ISO/" title="In ISO">ISO</a>
</div>

    <span><a href="/2023/08/15/%E8%BA%AB%E4%BB%BD%E8%AF%81%E6%A0%A1%E9%AA%8C%E7%AE%97%E6%B3%95-ISO-7064-1983-MOD-11-2/" title="身份证校验算法 (ISO 7064:1983.MOD 11-2)">身份证校验算法 (ISO 7064:1983.MOD 11-2)</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Linux-Kubernetes/" title="In Linux Kubernetes">Linux Kubernetes</a>
</div>

    <span><a href="/2023/02/01/Linux%E6%90%AD%E5%BB%BAk8s%E7%8E%AF%E5%A2%83/" title="Linux搭建k8s环境">Linux搭建k8s环境</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/HTTP/" title="In HTTP">HTTP</a>
</div>

    <span><a href="/2023/07/04/HTTP%E7%8A%B6%E6%80%81%E7%A0%81/" title="HTTP状态码">HTTP状态码</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython-C/" title="In CPython C">CPython C</a>
</div>

    <span><a href="/2022/11/16/Inside-The-Python-Virtual-Machine-Python-Objects/" title="Inside The Python Virtual Machine - Python Objects">Inside The Python Virtual Machine - Python Objects</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">小芳芳 @ Waim Chiu</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/11/16/CPython中变量是如何实现的/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
