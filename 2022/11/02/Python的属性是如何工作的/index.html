



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="士多啤梨苹果橙" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="士多啤梨苹果橙" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="士多啤梨苹果橙" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="CPython,C" />


<link rel="canonical" href="http://example.com/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/">



  <title>
Python的属性是如何工作的 - C - CPython |
Leayoos Chui = 士多啤梨苹果橙</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Python的属性是如何工作的
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-11-02 17:02:10">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-11-02T17:02:10+08:00">2022-11-02</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Leayoos Chui</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipexw3o58j20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclfdu6exj20zk0m87hw.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipesng5oej20zk0m87d4.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipewf5l51j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipeuibk9fj20zk0m8ay2.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CPython/" itemprop="item" rel="index" title="In CPython"><span itemprop="name">CPython</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CPython/C/" itemprop="item" rel="index" title="In C"><span itemprop="name">C</span></a>
<meta itemprop="position" content="2" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.png">
    <meta itemprop="name" content="小芳芳">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="士多啤梨苹果橙">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="python的属性是如何工作的"><a class="markdownIt-Anchor" href="#python的属性是如何工作的">#</a> Python 的属性是如何工作的？</h1>
<p>当我们获取或设置 Python 对象的属性时会发生什么？为了对更好理解属性是如何工作的，我们来研究一下属性是如何实现的。</p>
<blockquote>
<p>本篇使用的 CPython 的 3.9.12 版本，可能与前面的版本会有变化</p>
</blockquote>
<p>Python 对象是至少有两个成员的 C 结构体的实例：</p>
<ul>
<li>引用计数（a reference count）</li>
<li>指向对象类型的指针（a pointer to the object’s type）</li>
</ul>
<p>每个对象都必须有一个类型，因为该类型将决定对象的行为，当然，类型也是一个 Python 对象，也就是 PyTypeObject 结构的一个实例</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// include/cpython/object.h</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// PyTypeObject is a typedef for "struct _typeobject"</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">_typeobject</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    PyObject_VAR_HEAD</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tp_name<span class="token punctuation">;</span> <span class="token comment">/* For printing, in format "&lt;module>.&lt;name>" */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    Py_ssize_t tp_basicsize<span class="token punctuation">,</span> tp_itemsize<span class="token punctuation">;</span> <span class="token comment">/* For allocation */</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/* Methods to implement standard operations */</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    destructor tp_dealloc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    Py_ssize_t tp_vectorcall_offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    getattrfunc tp_getattr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    setattrfunc tp_setattr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    PyAsyncMethods <span class="token operator">*</span>tp_as_async<span class="token punctuation">;</span> <span class="token comment">/* formerly known as tp_compare (Python 2)</pre></td></tr><tr><td data-num="16"></td><td><pre>                                    or tp_reserved (Python 3) */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    reprfunc tp_repr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/* Method suites for standard classes */</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    PyNumberMethods <span class="token operator">*</span>tp_as_number<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    PySequenceMethods <span class="token operator">*</span>tp_as_sequence<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    PyMappingMethods <span class="token operator">*</span>tp_as_mapping<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/* More standard operations (here for binary compatibility) */</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    hashfunc tp_hash<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    ternaryfunc tp_call<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    reprfunc tp_str<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    getattrofunc tp_getattro<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    setattrofunc tp_setattro<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">/* Functions to access object as input/output buffer */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    PyBufferProcs <span class="token operator">*</span>tp_as_buffer<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">/* Flags to define presence of optional/expanded features */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tp_flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>tp_doc<span class="token punctuation">;</span> <span class="token comment">/* Documentation string */</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/* Assigned meaning in release 2.0 */</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">/* call function for all accessible objects */</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    traverseproc tp_traverse<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">/* delete references to contained objects */</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    inquiry tp_clear<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token comment">/* Assigned meaning in release 2.1 */</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token comment">/* rich comparisons */</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    richcmpfunc tp_richcompare<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">/* weak reference enabler */</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    Py_ssize_t tp_weaklistoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/* Iterators */</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    getiterfunc tp_iter<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    iternextfunc tp_iternext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">/* Attribute descriptor and subclassing stuff */</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">PyMethodDef</span> <span class="token operator">*</span>tp_methods<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">PyMemberDef</span> <span class="token operator">*</span>tp_members<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">PyGetSetDef</span> <span class="token operator">*</span>tp_getset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">struct</span> <span class="token class-name">_typeobject</span> <span class="token operator">*</span>tp_base<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    PyObject <span class="token operator">*</span>tp_dict<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    descrgetfunc tp_descr_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    descrsetfunc tp_descr_set<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    Py_ssize_t tp_dictoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    initproc tp_init<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    allocfunc tp_alloc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    newfunc tp_new<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    freefunc tp_free<span class="token punctuation">;</span> <span class="token comment">/* Low-level free-memory routine */</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    inquiry tp_is_gc<span class="token punctuation">;</span> <span class="token comment">/* For PyObject_IS_GC */</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    PyObject <span class="token operator">*</span>tp_bases<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    PyObject <span class="token operator">*</span>tp_mro<span class="token punctuation">;</span> <span class="token comment">/* method resolution order */</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    PyObject <span class="token operator">*</span>tp_cache<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    PyObject <span class="token operator">*</span>tp_subclasses<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    PyObject <span class="token operator">*</span>tp_weaklist<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    destructor tp_del<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token comment">/* Type attribute cache version tag. Added in version 2.6 */</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> tp_version_tag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    destructor tp_finalize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    vectorcallfunc tp_vectorcall<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>类型的成员称为槽，每个槽负责对象的特定行为，例如类型的 tp_call，将会指定我们调用该类型的对象时会发生什么。</p>
<p>如何设置类型的槽取决于如何定义类型，在 CPython 中定义类型有两种方法：</p>
<ul>
<li>静态（statically）</li>
<li>动态（dynamically）</li>
</ul>
<p>静态定义的类型只是 PyTypeObject 的静态初始化实例，所有内置类型都是静态定义的，比如 float 类型的定义</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>PyTypeObject PyFloat_Type <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">PyVarObject_HEAD_INIT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyType_Type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token string">"float"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">sizeof</span><span class="token punctuation">(</span>PyFloatObject<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">(</span>destructor<span class="token punctuation">)</span>float_dealloc<span class="token punctuation">,</span>                  <span class="token comment">/* tp_dealloc */</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_vectorcall_offset */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_getattr */</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_setattr */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_async */</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">(</span>reprfunc<span class="token punctuation">)</span>float_repr<span class="token punctuation">,</span>                       <span class="token comment">/* tp_repr */</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token operator">&amp;</span>float_as_number<span class="token punctuation">,</span>                           <span class="token comment">/* tp_as_number */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_sequence */</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_mapping */</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">(</span>hashfunc<span class="token punctuation">)</span>float_hash<span class="token punctuation">,</span>                       <span class="token comment">/* tp_hash */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_call */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_str */</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    PyObject_GenericGetAttr<span class="token punctuation">,</span>                    <span class="token comment">/* tp_getattro */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_setattro */</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_as_buffer */</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    Py_TPFLAGS_DEFAULT <span class="token operator">|</span> Py_TPFLAGS_BASETYPE<span class="token punctuation">,</span>   <span class="token comment">/* tp_flags */</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    float_new__doc__<span class="token punctuation">,</span>                           <span class="token comment">/* tp_doc */</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_traverse */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_clear */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    float_richcompare<span class="token punctuation">,</span>                          <span class="token comment">/* tp_richcompare */</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_weaklistoffset */</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_iter */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_iternext */</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    float_methods<span class="token punctuation">,</span>                              <span class="token comment">/* tp_methods */</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_members */</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    float_getset<span class="token punctuation">,</span>                               <span class="token comment">/* tp_getset */</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_base */</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_dict */</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_descr_get */</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_descr_set */</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_dictoffset */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_init */</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token number">0</span><span class="token punctuation">,</span>                                          <span class="token comment">/* tp_alloc */</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    float_new<span class="token punctuation">,</span>                                  <span class="token comment">/* tp_new */</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>如果要动态分配新类型，我们可以调用元类型，元类型是实例为 type 类型的类型。Python 有一个 type 的内置类，它是所有类型的原型，它被用作创建类的默认元类型。当 CPython 执行 class 语句时，它通常会调用 type () 来创建类。我们也可以通过直接调用 type () 来动态创建一个类</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre>MyClass <span class="token operator">=</span> <span class="token builtin">type</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> bases<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span></pre></td></tr></table></figure><p>类型的 tp_new 被调用以创建一个类，也就是__new__方法，该函数分配类型对象和空间并设置它。</p>
<p>所有类型都必须通过调用 PyType_Ready () 函数来初始化，PyType_Ready () 由 type_new () 调用。对于静态定义的类型，必须显式调用 PyType_Ready ()。当 CPython 启动时，它为每个内置类型调用 PyType_Ready ()。</p>
<h3 id="attributes-and-the-vm"><a class="markdownIt-Anchor" href="#attributes-and-the-vm">#</a> Attributes and the VM</h3>
<p>在 Python 中，可以使用属性做三件事：</p>
<ul>
<li>获取属性的值：value = obj.attr</li>
<li>设置属性值: obj.attr = value</li>
<li>删除属性: del obj.attr</li>
</ul>
<p>与对象行为的其它一样，这些操作的作用取决于对象的类型。一个类型有一些负责获取、设置和删除属性的槽，VM 通过调用这些槽来执行 value = obj.attr  和 obj.attr = value 等语句。</p>
<p>那么 VM 是如果做到的，我们通过一下方法观察：</p>
<ol>
<li>编写一段获取 / 设置 / 删除属性的代码</li>
<li>使用内置 dis module，反汇编为 bytecode</li>
<li>生成的 bytecode 指令的实现<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy45L1B5dGhvbi9jZXZhbC5j"> ceval.c</span></li>
</ol>
<h3 id="getting-an-attribute"><a class="markdownIt-Anchor" href="#getting-an-attribute">#</a> Getting an attribute</h3>
<p>当我们得到一个属性的值时，VM 会做什么，通过字节码观察到，编译器生成 LOAD_ATTR 操作码来加载值</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dis.dis<span class="token punctuation">(</span><span class="token string">'obj.attr'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> LOAD_ATTR                <span class="token number">1</span> <span class="token punctuation">(</span>attr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">4</span> RETURN_VALUE</pre></td></tr></table></figure><p>VM 执行这个操作码</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>LOAD_ATTR<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token function">TOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token function">PyObject_GetAttr</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">SET_TOP</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以看到 VM 调用了 PyObject_GetAttr 函数来完成工作</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">PyObject_GetAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_getattro <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-></span>tp_getattro<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_getattr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name_str <span class="token operator">=</span> <span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>name_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-></span>tp_getattr<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>name_str<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                 <span class="token string">"'%.50s' object has no attribute '%U'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                 tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>它首先尝试调用 tp_getattro，如果没有实现该方法，它会再尝试调用 tp_getattr，如果也没有实现，则会引发 AttributeError。</p>
<p>type 实现 tp_getattro 或 tp_getattr 或者两者，都支持属性访问，唯一区别在于 tp_getattro 采用 Python 字符串作为属性的名称，而 tp_getattr 采用 C 字符串，不过 tp_getattr 已经被弃用了，转而使用 tp_getattro。</p>
<h3 id="setting-an-attribute"><a class="markdownIt-Anchor" href="#setting-an-attribute">#</a> Setting an attribute</h3>
<p>从 VM 的角度来说，设置属性与获取属性没太大区别，编译器生成 STORE_ATTR 操作码，将属性设置为某个值</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dis.dis<span class="token punctuation">(</span><span class="token string">'obj.attr = value'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> LOAD_NAME                <span class="token number">1</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">4</span> STORE_ATTR               <span class="token number">2</span> <span class="token punctuation">(</span>attr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token number">6</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span>None<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token number">8</span> RETURN_VALUE</pre></td></tr></table></figure><p>STORE_ATTR 操作码</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>STORE_ATTR<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token function">TOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token function">SECOND</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">STACK_SHRINK</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    err <span class="token operator">=</span> <span class="token function">PyObject_SetAttr</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>可以发现，是通过 PyObject_SetAttr 来完成设置工作</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">PyObject_SetAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>v<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token function">PyUnicode_InternInPlace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_setattro <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-></span>tp_setattro<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_setattr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name_str <span class="token operator">=</span> <span class="token function">PyUnicode_AsUTF8</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>name_str <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>tp<span class="token operator">-></span>tp_setattr<span class="token punctuation">)</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>name_str<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token function">Py_REFCNT</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_getattr <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> tp<span class="token operator">-></span>tp_getattro <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                     <span class="token string">"'%.100s' object has no attributes "</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                     <span class="token string">"(%s .%U)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                     tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                     value<span class="token operator">==</span><span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"del"</span> <span class="token operator">:</span> <span class="token string">"assign to"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                     name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                     <span class="token string">"'%.100s' object has only read-only attributes "</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                     <span class="token string">"(%s .%U)"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                     tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                     value<span class="token operator">==</span><span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"del"</span> <span class="token operator">:</span> <span class="token string">"assign to"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                     name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="deleting-an-attribute"><a class="markdownIt-Anchor" href="#deleting-an-attribute">#</a> Deleting an attribute</h3>
<p>在 Python 中，有趣的是，类型没有用于删除属性的特殊槽。那么要如何指定删除属性？通过编译器生成 DELETE_ATTR 操作码以删除一个属性</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dis.dis<span class="token punctuation">(</span><span class="token string">'del obj.attr'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> DELETE_ATTR              <span class="token number">1</span> <span class="token punctuation">(</span>attr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">4</span> LOAD_CONST               <span class="token number">0</span> <span class="token punctuation">(</span>None<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token number">6</span> RETURN_VALUE</pre></td></tr></table></figure><p>VM 通过执行这个操作码来实现</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">case</span> <span class="token function">TARGET</span><span class="token punctuation">(</span>DELETE_ATTR<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    PyObject <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token function">GETITEM</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> oparg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>owner <span class="token operator">=</span> <span class="token function">POP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span> err<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    err <span class="token operator">=</span> <span class="token function">PyObject_SetAttr</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">goto</span> error<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">DISPATCH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>删除属性时，VM 调用相同的 PyObject_SetAttr 函数来设置属性，tp_setattro 槽负责删除属性，但它通过 NULL 来指示删除该属性。</p>
<h3 id="generic-attribute-management"><a class="markdownIt-Anchor" href="#generic-attribute-management">#</a> Generic attribute management</h3>
<p>PyObject_GenericGetAttr 和 PyObject_GenericSetAttr 函数实现了属性行为，比如将一个对象的属性设置为某个值时，CPython 会将该值放入对象的 dictionary 中</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> class A:</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.     pass</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> A<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.__dict__</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.x <span class="token operator">=</span> <span class="token string">"x attr"</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.__dict__</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span><span class="token string">'x'</span><span class="token builtin class-name">:</span> <span class="token string">'x attr'</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>当我们尝试获取属性的值时，CPython 就会从对象的 dictionary 中加载它</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.x</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">'x attr'</span></pre></td></tr></table></figure><p>如果对象的 dictionary 中不存在该属性，CPython 将从该类型的 dictionary 中加载它</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> A.y <span class="token operator">=</span> <span class="token string">"class y attr"</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.y</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">'class y attr'</span></pre></td></tr></table></figure><p>如果该类型的 dictionary 也不存在该属性，CPython 将会在该类型父类的 dictionary 中搜索该值</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> class B<span class="token punctuation">(</span>A<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.     pass</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> b <span class="token operator">=</span> B<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> b.y</pre></td></tr><tr><td data-num="6"></td><td><pre>'class y attr</pre></td></tr></table></figure><p>一个对象的属性有两种情况：</p>
<ul>
<li>实例变量</li>
<li>类型变量</li>
</ul>
<p>实例变量存储在对象的字典中，类型变量存储在类型的字典和类型父类的字典中。要将属性设置为某个值，CPython 只需要更新对象的 dictionary。为了获取属性的值，CPython 首先会在对象的 dictionary 中查找它，如果没有找到，就会在类型的 dictionary 和类型父类的 dictionary 中查找它。CPython 在查找值时会迭代这些类型 MRO（Method ResoltionOrder）。</p>
<h3 id="descriptors"><a class="markdownIt-Anchor" href="#descriptors">#</a> Descriptors</h3>
<p>什么是描述符，描述符是一个 Python 对象，其类型实现了 tp_descr_get 或 tp_descr_set 方法，也就是 Python 中的__get__和__set__方法。如果 PyObject_GerericGetAttr 函数在调用中发现属性值是一个描述符，其类型实现了 tp_descr_get 方法，那么就会调用 tp_descr_get 方法并返回调用结果。tp_descr_get 方法接受三个参数：描述符本身，正在查找其属性的对象和对象的类型。至于返回什么取决于 tp_descr_get 的实现。</p>
<blockquote>
<p>Python 中的 property 就是基于 tp_descr_get 和 tp_descr_set 实现的：<span class="exturl" data-url="aHR0cHM6Ly9jbGF5LXpoYW8uZ2l0aHViLmlvLzIwMjIvMDgvMTIvUHl0aG9uJTIwUHJvcGVydHklRTYlQkElOTAlRTclQTAlODElRTUlODglODYlRTYlOUUlOTAv">Property 源码分析</span></p>
</blockquote>
<p>PyObject_GenericSetAttr 函数在查找当前属性值时，如果发现该值的类型实现了 tp_descr_set 方法，就会调用 tp_descr_set 方法，而不仅仅是更新对象的字典。传递给 tp_descr_set 的参数有描述符本身、对象和新属性值。要删除一个属性，PyObject_GenericSetAttr 也会调用 tp_descr_set，但将新属性值设置为 NULL。</p>
<blockquote>
<p>Understanding descriptors is a key to a deep understanding of Python because they are the basis for many features including functions, methods, properties, class methods, static methods, and reference to super classes.</p>
</blockquote>
<p>在类型中的方法不同于普通函数，比如说当我们调用一个对象的方法时，我们不需要显式的传递它</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> A.f <span class="token operator">=</span> lambda self: self</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">&lt;</span>__main__.A object at 0x00000128F0AEB49<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr></table></figure><p>A.f 看起来像属性，它还是一个方法。</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.f</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>bound method <span class="token operator">&lt;</span>lambda<span class="token operator">></span> of <span class="token operator">&lt;</span>__main__.A object at 0x00000128F0AEB49<span class="token operator"><span class="token file-descriptor important">0</span>>></span></pre></td></tr></table></figure><p>如果我们直接通过类型的字典中查找 f 值，我们将得到原来的函数</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> A.__dict__<span class="token punctuation">[</span><span class="token string">'f'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>function <span class="token operator">&lt;</span>lambda<span class="token operator">></span> at 0x00000128F067F16<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr></table></figure><p>CPython 返回的不是字典中存储的值，而是其他值，因为函数是描述符，其函数类型实现了 tp_descr_get 方法，所以，当你调用 PyObject_GenericGetAttr 时，它就会调用 tp_descr_get 方法并返回调用结果。</p>
<p>当我们调用一个方法对象时，实例会被放在参数列表的前面，然后函数调用</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Bind a function to an object */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">static</span> PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">func_descr_get</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>func<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> Py_None <span class="token operator">||</span> obj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> func<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">PyMethod_New</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 变成了 method 对象</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 最终调用该方法</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">static</span> PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token function">method_vectorcall</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>method<span class="token punctuation">,</span> PyObject <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>args<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                  <span class="token class-name">size_t</span> nargsf<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>kwnames<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    PyObject <span class="token operator">*</span>self <span class="token operator">=</span> <span class="token function">PyMethod_GET_SELF</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 self</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    newargs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token operator">*</span> undefined behaviour<span class="token punctuation">.</span> <span class="token operator">*</span><span class="token operator">/</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 将 self 作为第一个参数</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    result <span class="token operator">=</span> <span class="token function">_PyObject_VectorcallTstate</span><span class="token punctuation">(</span>tstate<span class="token punctuation">,</span> func<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                                        newargs<span class="token punctuation">,</span> nargs<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> kwnames<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>需要注意的是，描述符只有在类型变量时才会触发，当被作为实例变量时，它的行为和普通对象相似，放在对象字典中的函数不会成为方法。</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.f</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>bound method <span class="token operator">&lt;</span>lambda<span class="token operator">></span> of <span class="token operator">&lt;</span>__main__.A object at 0x00000128F0AEB49<span class="token operator"><span class="token file-descriptor important">0</span>>></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.f<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span>__main__.A object at 0x00000128F0AEB49<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.g</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span>function <span class="token operator">&lt;</span>lambda<span class="token operator">></span> at 0x00000128F0B4E67<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.g<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="9"></td><td><pre>  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>TypeError: <span class="token operator">&lt;</span>lambda<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> missing <span class="token number">1</span> required positional argument: <span class="token string">'self'</span></pre></td></tr></table></figure><p>我们可以自定义一个描述符类型，实现__get__、__set__、__delete__魔法方法</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> class DescrClass:</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.     def __get__<span class="token punctuation">(</span>self, obj, <span class="token assign-left variable">type</span><span class="token operator">=</span>None<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">..</span>.         print<span class="token punctuation">(</span><span class="token string">"something happed..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">..</span>.         <span class="token builtin class-name">return</span> self</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> A.descr_attr <span class="token operator">=</span> DescrClass<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> A.descr_attr</pre></td></tr><tr><td data-num="8"></td><td><pre>something happed<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">&lt;</span>__main__.DescrClass object at 0x00000128F0536CD<span class="token operator"><span class="token file-descriptor important">0</span>></span></pre></td></tr></table></figure><p>如果一个类定义了__get__，CPython 将其 tp_descr_get 设置为调用该方法的函数。如果一个类定义了__set__或者__delete__，CPython 在 tp_descr_set 设置为当前值为 NULL 时会调用__delete__函数，否则调用__set__函数。</p>
<blockquote>
<p>If you wonder why anyone would want to define their our descriptors in the first place, check out the excellent <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvemgtY24vMy9ob3d0by9kZXNjcmlwdG9yLmh0bWwjaWQx">Descriptor HowTo Guide</span> by Raymond Hettinger.</p>
</blockquote>
<h3 id="objects-dictionary-and-types-dictionary"><a class="markdownIt-Anchor" href="#objects-dictionary-and-types-dictionary">#</a> Object’s dictionary and type’s dictionary</h3>
<p>对象的字典是存储实例变量的字典。类型的每个对象都有一个指向自己字典的指针。例如函数对象的 func_dict。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyObject <span class="token operator">*</span>func_dict<span class="token punctuation">;</span>        <span class="token comment">/* The __dict__ attribute, </pre></td></tr><tr><td data-num="4"></td><td><pre>    // ......</pre></td></tr><tr><td data-num="5"></td><td><pre>&#125; PyFunctionObject;</span></pre></td></tr></table></figure><p>要告诉 CPython 某个对象的哪个成员是指向该对象的字典的指针，该对象的类型使用 tp_dictoffset 来指定该成员的偏移量。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>PyTypeObject PyFunction_Type <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">offsetof</span><span class="token punctuation">(</span>PyFunctionObject<span class="token punctuation">,</span> func_dict<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// tp_dictoffset</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>tp_dictoffset 的正值指定从对象的结构开始的偏移量。负值指定从结构的末尾开始的偏移量。零偏移量表示该类型的对象没有字典。例如整数对象</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>.__dict__</pre></td></tr><tr><td data-num="2"></td><td><pre>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="3"></td><td><pre>  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>AttributeError: <span class="token string">'int'</span> object has no attribute <span class="token string">'__dict__'</span></pre></td></tr></table></figure><p>通过__dictoffset__属性可以看到 int 类型的 tp_dictoffset 设置为 0 了</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> int.__dictoffset__</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">0</span></pre></td></tr></table></figure><p>当我们知道描述符是什么以及属性存储在哪里，就可以看到 PyObject_GenericGetAttr 和 PyObject_GenericSetAttr 函数的作用了</p>
<h3 id="pyobject_genericsetattr"><a class="markdownIt-Anchor" href="#pyobject_genericsetattr">#</a> PyObject_GenericSetAttr</h3>
<p>PyObject_GenericSetAttr 将属性设置为特定的值，但实际上真正实现的是另一个函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">PyObject_GenericSetAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">_PyObject_GenericSetAttrWithDict</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">_PyObject_GenericGetAttrWithDict</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                 PyObject <span class="token operator">*</span>dict<span class="token punctuation">,</span> <span class="token keyword">int</span> suppress<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/* Make sure the logic of _PyObject_GetMethod is in sync with</pre></td></tr><tr><td data-num="12"></td><td><pre>       this method.</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>       When suppress=1, this function suppress AttributeError.</pre></td></tr><tr><td data-num="15"></td><td><pre>    */</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    PyObject <span class="token operator">*</span>descr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    PyObject <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    descrgetfunc f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    Py_ssize_t dictoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    PyObject <span class="token operator">*</span><span class="token operator">*</span>dictptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    descr <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    f <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        f <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token operator">-></span>tp_descr_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyDescr_IsData</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>descr<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> suppress <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">/* Inline _PyObject_GetDictPtr */</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        dictoffset <span class="token operator">=</span> tp<span class="token operator">-></span>tp_dictoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dictoffset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dictoffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                Py_ssize_t tsize <span class="token operator">=</span> <span class="token function">Py_SIZE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>tsize <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    tsize <span class="token operator">=</span> <span class="token operator">-</span>tsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token class-name">size_t</span> size <span class="token operator">=</span> <span class="token function">_PyObject_VAR_SIZE</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> tsize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> size <span class="token operator">&lt;=</span> PY_SSIZE_T_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>                dictoffset <span class="token operator">+=</span> <span class="token punctuation">(</span>Py_ssize_t<span class="token punctuation">)</span>size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> dictoffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> dictoffset <span class="token operator">%</span> SIZEOF_VOID_P <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            dictptr <span class="token operator">=</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj <span class="token operator">+</span> dictoffset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            dict <span class="token operator">=</span> <span class="token operator">*</span>dictptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">PyDict_GetItemWithError</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>suppress <span class="token operator">&amp;&amp;</span> <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>descr<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> suppress <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        res <span class="token operator">=</span> descr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        descr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>suppress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                     <span class="token string">"'%.50s' object has no attribute '%U'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                     tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  done<span class="token operator">:</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token function">PyObject_GenericGetAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="122"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">_PyObject_GenericGetAttrWithDict</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token function">_PyObject_GenericSetAttrWithDict</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                                 PyObject <span class="token operator">*</span>value<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>dict<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="129"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    PyObject <span class="token operator">*</span>descr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    descrsetfunc f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    PyObject <span class="token operator">*</span><span class="token operator">*</span>dictptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">int</span> res <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="138"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="139"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyType_Ready</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre>    descr <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>        f <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token operator">-></span>tp_descr_set<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>descr<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="158"></td><td><pre></pre></td></tr><tr><td data-num="159"></td><td><pre>    <span class="token comment">/* XXX [Steve Dower] These are really noisy - worth it? */</span></pre></td></tr><tr><td data-num="160"></td><td><pre>    <span class="token comment">/*if (PyType_Check(obj) || PyModule_Check(obj)) &#123;</pre></td></tr><tr><td data-num="161"></td><td><pre>        if (value &amp;&amp; PySys_Audit("object.__setattr__", "OOO", obj, name, value) &lt; 0)</pre></td></tr><tr><td data-num="162"></td><td><pre>            return -1;</pre></td></tr><tr><td data-num="163"></td><td><pre>        if (!value &amp;&amp; PySys_Audit("object.__delattr__", "OO", obj, name) &lt; 0)</pre></td></tr><tr><td data-num="164"></td><td><pre>            return -1;</pre></td></tr><tr><td data-num="165"></td><td><pre>    &#125;*/</span></pre></td></tr><tr><td data-num="166"></td><td><pre></pre></td></tr><tr><td data-num="167"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>        dictptr <span class="token operator">=</span> <span class="token function">_PyObject_GetDictPtr</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dictptr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>                <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="172"></td><td><pre>                             <span class="token string">"'%.100s' object has no attribute '%U'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="173"></td><td><pre>                             tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>            <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="176"></td><td><pre>                <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="177"></td><td><pre>                             <span class="token string">"'%.50s' object attribute '%U' is read-only"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="178"></td><td><pre>                             tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">_PyObjectDict_SetItem</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> dictptr<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="187"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">PyDict_DelItem</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        <span class="token keyword">else</span></pre></td></tr><tr><td data-num="189"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">PyDict_SetItem</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_KeyError<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="193"></td><td><pre>        <span class="token function">PyErr_SetObject</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre></pre></td></tr><tr><td data-num="195"></td><td><pre>  done<span class="token operator">:</span></pre></td></tr><tr><td data-num="196"></td><td><pre>    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>它做几件事情：</p>
<ol>
<li>在类型变量中通过 MRO 搜索属性值</li>
<li>如果值类型实现了 tp_descr_set，将会调用 tp_descr_set</li>
<li>否则，使用新值更到对象的字典</li>
</ol>
<h3 id="pyobject_genericgetattr"><a class="markdownIt-Anchor" href="#pyobject_genericgetattr">#</a> PyObject_GenericGetAttr</h3>
<p>获取属性值比设置复杂一些，实际真正调用的也是另一个函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">PyObject_GenericGetAttr</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">_PyObject_GenericGetAttrWithDict</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">_PyObject_GenericGetAttrWithDict</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                 PyObject <span class="token operator">*</span>dict<span class="token punctuation">,</span> <span class="token keyword">int</span> suppress<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/* Make sure the logic of _PyObject_GetMethod is in sync with</pre></td></tr><tr><td data-num="12"></td><td><pre>       this method.</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>       When suppress=1, this function suppress AttributeError.</pre></td></tr><tr><td data-num="15"></td><td><pre>    */</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    PyObject <span class="token operator">*</span>descr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    PyObject <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    descrgetfunc f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    Py_ssize_t dictoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    PyObject <span class="token operator">*</span><span class="token operator">*</span>dictptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    descr <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    f <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        f <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token operator">-></span>tp_descr_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyDescr_IsData</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>descr<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> suppress <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">/* Inline _PyObject_GetDictPtr */</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        dictoffset <span class="token operator">=</span> tp<span class="token operator">-></span>tp_dictoffset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dictoffset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>dictoffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                Py_ssize_t tsize <span class="token operator">=</span> <span class="token function">Py_SIZE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>tsize <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    tsize <span class="token operator">=</span> <span class="token operator">-</span>tsize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token class-name">size_t</span> size <span class="token operator">=</span> <span class="token function">_PyObject_VAR_SIZE</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> tsize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> size <span class="token operator">&lt;=</span> PY_SSIZE_T_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>                dictoffset <span class="token operator">+=</span> <span class="token punctuation">(</span>Py_ssize_t<span class="token punctuation">)</span>size<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> dictoffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                <span class="token function">_PyObject_ASSERT</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> dictoffset <span class="token operator">%</span> SIZEOF_VOID_P <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            dictptr <span class="token operator">=</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>obj <span class="token operator">+</span> dictoffset<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            dict <span class="token operator">=</span> <span class="token operator">*</span>dictptr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dict <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">PyDict_GetItemWithError</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyErr_Occurred</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>suppress <span class="token operator">&amp;&amp;</span> <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                    <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>                <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>                    <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>descr<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> suppress <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        res <span class="token operator">=</span> descr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        descr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token keyword">goto</span> done<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>suppress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>                     <span class="token string">"'%.50s' object has no attribute '%U'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                     tp<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  done<span class="token operator">:</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该算法的主要逻辑：</p>
<ol>
<li>在类型变量通过遍历 MRO 查找属性</li>
<li>如果值是一个描述符，通过调用__get__并返回调用结果，否则保存该值，继续往下走</li>
<li>定位对象的字典。如果字典包含该值，则返回</li>
<li>如果步骤 2 中的值是一个描述符，其类型实现了 tp_descr_get，调用 tp_descr_get 并返回调用结果</li>
<li>返回步骤 2 中的值。该值可以为 NULL</li>
</ol>
<p>由于一个属性既可以是实例变量，也可以是类型变量，所以 CPython 必须决定哪个属性优先于另一个属性，该算法实际实现了一个优先顺序：</p>
<ol>
<li>类型数据描述符</li>
<li>实例变量</li>
<li>类型非数据描述符和其它类型变量</li>
</ol>
<p>那么为什么 CPython 会让数据描述符优先于实例变量，而非数据描述符不优先？，这个话题单独开另一篇文章来唠唠🐱‍👤</p>
<h3 id="metatype-attribute-management"><a class="markdownIt-Anchor" href="#metatype-attribute-management">#</a> Metatype attribute management</h3>
<p>基本上，类型的属性就像普通对象的属性一样工作。当我们将一个类型的属性设置为某个值时，CPython 会将该值放入类型的 dictionary 中</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> B.x <span class="token operator">=</span> <span class="token string">"class x attribute"</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> B.__dict__</pre></td></tr><tr><td data-num="3"></td><td><pre>mappingproxy<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">'__module__'</span><span class="token builtin class-name">:</span> <span class="token string">'__main__'</span>, <span class="token string">'__doc__'</span><span class="token builtin class-name">:</span> None, <span class="token string">'x'</span><span class="token builtin class-name">:</span> <span class="token string">'class x attribute'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>当我们得到属性的值时，CPython 从类型的 dictionary 中查找它</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> B.x</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token string">'class x attribute'</span></pre></td></tr></table></figure><p>那如果类型的 dictionary 不包含该属性，CPython 将从 metatype 的 dictionary 中查找它</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> B.__class__</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>class <span class="token string">'type'</span><span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> B.__class__ is object.__class__</pre></td></tr><tr><td data-num="4"></td><td><pre>True</pre></td></tr></table></figure><p>最后，如果 metatype 的 dictionary 中也找不到该属性，CPython 将在 metatype 父类的 dictionary 中查找该值。</p>
<p>type 实现了自己的 tp_getattro 和 tp_setattro</p>
<h4 id="type_setattro"><a class="markdownIt-Anchor" href="#type_setattro">#</a> type_setattro</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">type_setattro</span><span class="token punctuation">(</span>PyTypeObject <span class="token operator">*</span>type<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>type<span class="token operator">-></span>tp_flags <span class="token operator">&amp;</span> Py_TPFLAGS_HEAPTYPE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token string">"can't set attributes of built-in/extension type '%s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            type<span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyUnicode_CheckExact</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyUnicode_READY</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            name <span class="token operator">=</span> <span class="token function">_PyUnicode_Copy</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">INTERN_NAME_STRINGS</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_CHECK_INTERNED</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token function">PyUnicode_InternInPlace</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_CHECK_INTERNED</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token function">PyErr_SetString</span><span class="token punctuation">(</span>PyExc_MemoryError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                                <span class="token string">"Out of memory interning an attribute name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">/* Will fail in _PyObject_GenericSetAttrWithDict. */</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    res <span class="token operator">=</span> <span class="token function">_PyObject_GenericSetAttrWithDict</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">/* Clear the VALID_VERSION flag of 'type' and all its</pre></td></tr><tr><td data-num="42"></td><td><pre>           subclasses.  This could possibly be unified with the</pre></td></tr><tr><td data-num="43"></td><td><pre>           update_subclasses() recursion in update_slot(), but carefully:</pre></td></tr><tr><td data-num="44"></td><td><pre>           they each have their own conditions on which to stop</pre></td></tr><tr><td data-num="45"></td><td><pre>           recursing into subclasses. */</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token function">PyType_Modified</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dunder_name</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">update_slot</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">_PyType_CheckConsistency</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>该函数通过调用_PyObject_GenericSetAttrWithDict 来设置属性值，但它也执行了其他操作。首先，它确保类型不是静态定义的类型，因为这些类型被设计为 immutable。</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> int.x <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="3"></td><td><pre>  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>TypeError: can<span class="token string">'t set attributes of built-in/extension type '</span>int'</pre></td></tr></table></figure><p>除此之外，它还会检测属性是否为一个特殊方法，如果属性是一个特殊方法，它将更新与该特殊方法对应的 slot</p>
<h4 id="type_getattro"><a class="markdownIt-Anchor" href="#type_getattro">#</a> type_getattro</h4>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* This is similar to PyObject_GenericGetAttr(),</pre></td></tr><tr><td data-num="2"></td><td><pre>   but uses _PyType_Lookup() instead of just looking in type->tp_dict. */</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">static</span> PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">type_getattro</span><span class="token punctuation">(</span>PyTypeObject <span class="token operator">*</span>type<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    PyTypeObject <span class="token operator">*</span>metatype <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    PyObject <span class="token operator">*</span>meta_attribute<span class="token punctuation">,</span> <span class="token operator">*</span>attribute<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    descrgetfunc meta_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    PyObject<span class="token operator">*</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_TypeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                     <span class="token string">"attribute name must be string, not '%.200s'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                     <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token operator">-></span>tp_name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/* Initialize this type (we'll assume the metatype is initialized) */</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>type<span class="token operator">-></span>tp_dict <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyType_Ready</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/* No readable descriptor found yet */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    meta_get <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">/* Look for the attribute in the metatype */</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    meta_attribute <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>metatype<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>meta_attribute <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        meta_get <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token operator">-></span>tp_descr_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>meta_get <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyDescr_IsData</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token comment">/* Data descriptors implement tp_descr_set to intercept</pre></td></tr><tr><td data-num="36"></td><td><pre>             * writes. Assume the attribute is not overridden in</pre></td></tr><tr><td data-num="37"></td><td><pre>             * type's tp_dict (and bases): call the descriptor now.</pre></td></tr><tr><td data-num="38"></td><td><pre>             */</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">meta_get</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                           <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/* No data descriptor found on metatype. Look in tp_dict of this</pre></td></tr><tr><td data-num="47"></td><td><pre>     * type and its bases */</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    attribute <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">/* Implement descriptor functionality, if any */</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        descrgetfunc local_get <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token operator">-></span>tp_descr_get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token function">Py_XDECREF</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>local_get <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token comment">/* NULL 2nd argument indicates the descriptor was</pre></td></tr><tr><td data-num="58"></td><td><pre>             * found on the target object itself (or a base)  */</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            res <span class="token operator">=</span> <span class="token function">local_get</span><span class="token punctuation">(</span>attribute<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span><span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                            <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">return</span> attribute<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token comment">/* No attribute found in local __dict__ (or bases): use the</pre></td></tr><tr><td data-num="69"></td><td><pre>     * descriptor from the metatype, if any */</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>meta_get <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        PyObject <span class="token operator">*</span>res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">meta_get</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">,</span> <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>type<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                       <span class="token punctuation">(</span>PyObject <span class="token operator">*</span><span class="token punctuation">)</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>meta_attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token comment">/* If an ordinary attribute was found on the metatype, return it now */</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>meta_attribute <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">return</span> meta_attribute<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token comment">/* Give up */</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token function">PyErr_Format</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                 <span class="token string">"type object '%.50s' has no attribute '%U'"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                 type<span class="token operator">-></span>tp_name<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>有三个重要的区别：</p>
<ul>
<li>它通过 tp_dict 获取类型的字典。泛型实现将尝试使用 metatype 的 tp_dictoffset 来定位它</li>
<li>它不仅在类型的字典中搜索类型变量，而且还在类型父类的字典中搜索类型变量。泛型实现将处理像普通对象一样没有继承概念的类型</li>
<li>它支持描述符</li>
</ul>
<p>因此有以下优先顺序：</p>
<ol>
<li>元类型数据描述符</li>
<li>类型描述符和其它类型变量</li>
<li>元类型非数据描述符和其它元类型变量</li>
</ol>
<p>type 实现了 tp_getattro 和 tp_setattro，因为 type 是所有内置类型的 metatype，默认情况下是所有类的 metatype，所以大多数类型的属性都是根据这个实现工作的。</p>
<p>类本身默认情况下使用通用实现，如果我们想更改类实例的属性行为或类的属性行为，我们需要定义一个新的类或者一个使用自定义实现的 metatype。</p>
<h3 id="custom-attribute-management"><a class="markdownIt-Anchor" href="#custom-attribute-management">#</a> Custom attribute management</h3>
<p>类的 tp_getattro 和 tp_setattro 是由创建新类的 type_new 函数里面设置的。泛型实现是其默认选择。类可以通过定义<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#object.__getattribute__"><strong> getattribute</strong></a>、<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#object.__getattr__"><strong>getattr</strong></a>、<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#object.__setattr__"><strong>setattr</strong></a> 和<a target="_blank" rel="noopener" href="https://docs.python.org/3/reference/datamodel.html#object.__delattr__"><strong> delattr</strong></a> 魔法方法来定义属性的访问、赋值和删除。</p>
<p>当一个类定义了__setattr__或__delattr__时，它的 tp_setattro slot 会被设置为 slot_tp_setattro 函数。当一个类定义了__getattribute__或__getattr__时，它的 tp_getattro slot 会被设置为 slot_tp_getattr_hook 函数。</p>
<p>slot_tp_setattro 函数只调用__delattr__(instance, attr_name) 或__setattr__(instance, attr_name, value)，这取决于 value 是否为 NULL</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token keyword">int</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">slot_tp_setattro</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyObject <span class="token operator">*</span>stack<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    PyObject <span class="token operator">*</span>res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">_Py_IDENTIFIER</span><span class="token punctuation">(</span>__delattr__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">_Py_IDENTIFIER</span><span class="token punctuation">(</span>__setattr__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    stack<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    stack<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">vectorcall_method</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyId___delattr__<span class="token punctuation">,</span> stack<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">vectorcall_method</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyId___setattr__<span class="token punctuation">,</span> stack<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>__getattribute__和__getattr__魔法方法提供了一种定制的属性访问方法。两者都以一个实例和一个属性名作为参数，并返回属性值，区别在于何时调用它们。</p>
<p>__getattr__与__getattribute__或泛型函数一起使用。当__getattribute__或泛型函数引发 AttributeError 时调用它。实现逻辑在 slot_tp_getattr_hook 函数</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">slot_tp_getattr_hook</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    PyTypeObject <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">Py_TYPE</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    PyObject <span class="token operator">*</span>getattr<span class="token punctuation">,</span> <span class="token operator">*</span>getattribute<span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">_Py_IDENTIFIER</span><span class="token punctuation">(</span>__getattr__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/* speed hack: we could use lookup_maybe, but that would resolve the</pre></td></tr><tr><td data-num="9"></td><td><pre>       method fully for each attribute lookup for classes with</pre></td></tr><tr><td data-num="10"></td><td><pre>       __getattr__, even when the attribute is present. So we use</pre></td></tr><tr><td data-num="11"></td><td><pre>       _PyType_Lookup and create the method only when needed, with</pre></td></tr><tr><td data-num="12"></td><td><pre>       call_attribute. */</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    getattr <span class="token operator">=</span> <span class="token function">_PyType_LookupId</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PyId___getattr__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>getattr <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">/* No __getattr__ hook: use a simpler dispatcher */</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        tp<span class="token operator">-></span>tp_getattro <span class="token operator">=</span> slot_tp_getattro<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">slot_tp_getattro</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>getattr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/* speed hack: we could use lookup_maybe, but that would resolve the</pre></td></tr><tr><td data-num="21"></td><td><pre>       method fully for each attribute lookup for classes with</pre></td></tr><tr><td data-num="22"></td><td><pre>       __getattr__, even when self has the default __getattribute__</pre></td></tr><tr><td data-num="23"></td><td><pre>       method. So we use _PyType_Lookup and create the method only when</pre></td></tr><tr><td data-num="24"></td><td><pre>       needed, with call_attribute. */</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    getattribute <span class="token operator">=</span> <span class="token function">_PyType_LookupId</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PyId___getattribute__<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>getattribute <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">(</span><span class="token function">Py_IS_TYPE</span><span class="token punctuation">(</span>getattribute<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PyWrapperDescr_Type<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>         <span class="token punctuation">(</span><span class="token punctuation">(</span>PyWrapperDescrObject <span class="token operator">*</span><span class="token punctuation">)</span>getattribute<span class="token punctuation">)</span><span class="token operator">-></span>d_wrapped <span class="token operator">==</span></pre></td></tr><tr><td data-num="29"></td><td><pre>         <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>PyObject_GenericGetAttr<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">PyObject_GenericGetAttr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>getattribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">call_attribute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> getattribute<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>getattribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PyErr_ExceptionMatches</span><span class="token punctuation">(</span>PyExc_AttributeError<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">PyErr_Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        res <span class="token operator">=</span> <span class="token function">call_attribute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> getattr<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token function">Py_DECREF</span><span class="token punctuation">(</span>getattr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>代码做了几件事：</p>
<ol>
<li>如果类没有定义__getattr__，首先设置它的 tp_getattro 为 slot_tp_getattro 函数，然后调用该函数并返回调用结果</li>
<li>如果类定义了__getattribute__，就调用该函数并返回调用结果</li>
<li>如果来自上一步的调用引发了 AttributeError，就调用__getattr__</li>
<li>返回最后一次调用的结果</li>
</ol>
<p>slot_tp_getattr 函数是当类定义了__getattribute__而不是__getattr__时，CPython 使用 tp_getattro slot 的实现。这个函数只调用__getattribute__</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* There are two slot dispatch functions for tp_getattro.</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>   - slot_tp_getattro() is used when __getattribute__ is overridden</pre></td></tr><tr><td data-num="4"></td><td><pre>     but no __getattr__ hook is present;</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>   - slot_tp_getattr_hook() is used when a __getattr__ hook is present.</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>   The code in update_one_slot() always installs slot_tp_getattr_hook(); this</pre></td></tr><tr><td data-num="9"></td><td><pre>   detects the absence of __getattr__ and then installs the simpler slot if necessary. </pre></td></tr><tr><td data-num="10"></td><td><pre>*/</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">static</span> PyObject <span class="token operator">*</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">slot_tp_getattro</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>self<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    PyObject <span class="token operator">*</span>stack<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>self<span class="token punctuation">,</span> name<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">vectorcall_method</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PyId___getattribute__<span class="token punctuation">,</span> stack<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="loading-methods"><a class="markdownIt-Anchor" href="#loading-methods">#</a> Loading methods</h3>
<p>当我们获取或设置 Python 对象的属性时会发生什么，来探讨下 Python 属性比较重要的方面。</p>
<p>我们可以看到函数对象是一个描述符，当我们将它绑定到一个实例对象时，它返回一个 bound method</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> a.f</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>bound method <span class="token operator">&lt;</span>lambda<span class="token operator">></span> of <span class="token operator">&lt;</span>__main__.A object at 0x00000128F0AEB49<span class="token operator"><span class="token file-descriptor important">0</span>>></span></pre></td></tr></table></figure><p>当编译器看到带有像 object.method (args1, arg2, argN) 这样的位置参数的方法调用时，它不会产生加载该方法的 LOAD_ATTR 和调用该方法的 CALL_FUNCTION 操作码，相反，它会生成一对 LOAD_METHOD 和 CALL_METHOD 操作码：</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dis.dis<span class="token punctuation">(</span><span class="token string">"object.method()"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">1</span>           <span class="token number">0</span> LOAD_NAME                <span class="token number">0</span> <span class="token punctuation">(</span>object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token number">2</span> LOAD_METHOD              <span class="token number">1</span> <span class="token punctuation">(</span>method<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token number">4</span> CALL_METHOD              <span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token number">6</span> RETURN_VALUE</pre></td></tr></table></figure><p>当 VM 看到 LOAD_METHOD 操作码时，它调用_PyObject_GetMethod 函数来搜索属性值。此函数工作方式与泛型函数类似，区别在于它会检查该值是否是未绑定的方法，即返回绑定到实例的类似方法的对象的描述符。在这种情况下，它不调用描述符类型的 tp_descr_get 方法，而是返回描述符本身。例如属性值是一个函数，_PyObject_GetMethod 返回该函数。函数类型和其它描述符类型的对象作为未绑定的方法，在它的 tp_flag 中指定了 Py_TPFLAGS_METHOD_DESCRIPTOR flag，所以很容易识别出来。</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/* Objects behave like an unbound method */</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Py_TPFLAGS_METHOD_DESCRIPTOR</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1UL</span> <span class="token operator">&lt;&lt;</span> <span class="token number">17</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">int</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">_PyObject_GetMethod</span><span class="token punctuation">(</span>PyObject <span class="token operator">*</span>obj<span class="token punctuation">,</span> PyObject <span class="token operator">*</span>name<span class="token punctuation">,</span> PyObject <span class="token operator">*</span><span class="token operator">*</span>method<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">int</span> meth_found <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token operator">-></span>tp_getattro <span class="token operator">!=</span> PyObject_GenericGetAttr</pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">PyUnicode_Check</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token operator">*</span>method <span class="token operator">=</span> <span class="token function">PyObject_GetAttr</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    descr <span class="token operator">=</span> <span class="token function">_PyType_Lookup</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>descr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token function">Py_INCREF</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">_PyType_HasFeature</span><span class="token punctuation">(</span><span class="token function">Py_TYPE</span><span class="token punctuation">(</span>descr<span class="token punctuation">)</span><span class="token punctuation">,</span> Py_TPFLAGS_METHOD_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            meth_found <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>meth_found<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token operator">*</span>method <span class="token operator">=</span> descr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// ......</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>需要注意，_PyObject_GetMethod 只有在对象的类型使用 tp_getattro 的通用实现时才能正常工作。否则它只调用自定义实现，不执行任何检查。</p>
<p>如果_PyObject_GetMethod 找到一个未绑定的方法，则必须使用前置于参数列表的实例调用该方法。如果它发现其它不需要绑定到实例的可调用函数，参数列表必须保持不变。因此，在 VM 执行 LOAD_METHOD 之后，堆栈上的值可以以两种方式中的一种进行排列：</p>
<ul>
<li>未绑定的方法和包括实例在内的参数列表：(method | self | arg1 | … | argN)</li>
<li>其它可调用参数和没有实例的参数列表： (NULL | method| arg1 | … | argN)</li>
</ul>
<p>CALL_METHOD 操作码的存在是为了在每种情况下适当地调用该方法</p>
<h3 id="listing-attributes-of-an-object"><a class="markdownIt-Anchor" href="#listing-attributes-of-an-object">#</a> Listing attributes of an object</h3>
<p>Python 提供内置的 dir 函数，可用于查看对象具有哪些属性。但它是如何找到这些属性的？它通过调用对象类型的__dir__魔法方法来实现。类型很少会定义自己的__dir__，但所有类型都有它，这是因为对象类型定义了__dir__，而所有其它类型都继承了该对象。对象提供的实现列出了存储在对象的字典、类型的字典和类型父类的字典中的所有属性。这时因为 type 提供了自己的__dir__实现。此实现返回存储在类型的字典和类型父类的字典中的属性。但是它们忽略了存储在 metatype 的字典和 metatype 父类的字典中的属性。<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI2Rpcg==">文档</span>中解释道</p>
<blockquote>
<p>Because dir() is supplied primarily as a convenience for use at an interactive prompt, it tries to supply an interesting set of names more than it tries to supply a rigorously or consistently defined set of names, and its detailed behavior may change across releases. For example, metaclass attributes are not in the result list when the argument is a class.</p>
</blockquote>
<h3 id="where-attributes-of-types-come-from"><a class="markdownIt-Anchor" href="#where-attributes-of-types-come-from">#</a> Where attributes of types come from</h3>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dir<span class="token punctuation">(</span>object<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span><span class="token string">'__class__'</span>, <span class="token string">'__delattr__'</span>, <span class="token string">'__dir__'</span>, <span class="token string">'__doc__'</span>, <span class="token string">'__eq__'</span>, <span class="token string">'__format__'</span>, <span class="token string">'__ge__'</span>, <span class="token string">'__getattribute__'</span>, <span class="token string">'__gt__'</span>, <span class="token string">'__hash__'</span>, <span class="token string">'__init__'</span>, <span class="token string">'__init_subclass__'</span>, <span class="token string">'__le__'</span>, <span class="token string">'__lt__'</span>, <span class="token string">'__ne__'</span>, <span class="token string">'__new__'</span>, <span class="token string">'__reduce__'</span>, <span class="token string">'__reduce_ex__'</span>, <span class="token string">'__repr__'</span>, <span class="token string">'__setattr__'</span>, <span class="token string">'__sizeof__'</span>, <span class="token string">'__str__'</span>, <span class="token string">'__subclasshook__'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> dir<span class="token punctuation">(</span>int<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">[</span><span class="token string">'__abs__'</span>, <span class="token string">'__add__'</span>, <span class="token string">'__and__'</span>, <span class="token string">'__bool__'</span>, <span class="token string">'__ceil__'</span>, <span class="token string">'__class__'</span>, <span class="token string">'__delattr__'</span>, <span class="token string">'__dir__'</span>, <span class="token string">'__divmod__'</span>, <span class="token string">'__doc__'</span>, <span class="token string">'__eq__'</span>, <span class="token string">'__float__'</span>, <span class="token string">'__floor__'</span>, <span class="token string">'__floordiv__'</span>, <span class="token string">'__format__'</span>, <span class="token string">'__ge__'</span>, <span class="token string">'__getattribute__'</span>, <span class="token string">'__getnewargs__'</span>, <span class="token string">'__gt__'</span>, <span class="token string">'__hash__'</span>, <span class="token string">'__index__'</span>, <span class="token string">'__init__'</span>, <span class="token string">'__init_subclass__'</span>, <span class="token string">'__int__'</span>, <span class="token string">'__invert__'</span>, <span class="token string">'__le__'</span>, <span class="token string">'__lshift__'</span>, <span class="token string">'__lt__'</span>, <span class="token string">'__mod__'</span>, <span class="token string">'__mul__'</span>, <span class="token string">'__ne__'</span>, <span class="token string">'__neg__'</span>, <span class="token string">'__new__'</span>, <span class="token string">'__or__'</span>, <span class="token string">'__pos__'</span>, <span class="token string">'__pow__'</span>, <span class="token string">'__radd__'</span>, <span class="token string">'__rand__'</span>, <span class="token string">'__rdivmod__'</span>, <span class="token string">'__reduce__'</span>, <span class="token string">'__reduce_ex__'</span>, <span class="token string">'__repr__'</span>, <span class="token string">'__rfloordiv__'</span>, <span class="token string">'__rlshift__'</span>, <span class="token string">'__rmod__'</span>, <span class="token string">'__rmul__'</span>, <span class="token string">'__ror__'</span>, <span class="token string">'__round__'</span>, <span class="token string">'__rpow__'</span>, <span class="token string">'__rrshift__'</span>, <span class="token string">'__rshift__'</span>, <span class="token string">'__rsub__'</span>, <span class="token string">'__rtruediv__'</span>, <span class="token string">'__rxor__'</span>, <span class="token string">'__setattr__'</span>, <span class="token string">'__sizeof__'</span>, <span class="token string">'__str__'</span>, <span class="token string">'__sub__'</span>, <span class="token string">'__subclasshook__'</span>, <span class="token string">'__truediv__'</span>, <span class="token string">'__trunc__'</span>, <span class="token string">'__xor__'</span>, <span class="token string">'as_integer_ratio'</span>, <span class="token string">'bit_length'</span>, <span class="token string">'conjugate'</span>, <span class="token string">'denominator'</span>, <span class="token string">'from_bytes'</span>, <span class="token string">'imag'</span>, <span class="token string">'numerator'</span>, <span class="token string">'real'</span>, <span class="token string">'to_bytes'</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>对于魔法方法，是由初始化类型的 PyType_Ready 函数自动添加的，那其他属性呢？</p>
<p>指定类型属性的最直接方法是创建一个字典，用属性填充它，并将类型的 tp_dict 设置为该字典。PyType_Ready 函数在运行时创建内置类型的字典，它还负责添加所有属性。</p>
<p>首先，PyType_Ready 确保类型具有字典，然后它向字典添加属性。类型通过指定 tp_method、tp_member 和 tp_getset 来告诉 PyType_Ready 要添加哪些属性。每个 slot 都是一个结构数组，用于描述不同类型的属性。</p>
<h4 id="tp_method"><a class="markdownIt-Anchor" href="#tp_method">#</a> tp_method</h4>
<p>tp_method 是描述方法的 PyMthodDef 结构数组：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">struct</span> <span class="token class-name">PyMethodDef</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span>  <span class="token operator">*</span>ml_name<span class="token punctuation">;</span>   <span class="token comment">/* The name of the built-in function/method */</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    PyCFunction ml_meth<span class="token punctuation">;</span>    <span class="token comment">/* The C function that implements it */</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">int</span>         ml_flags<span class="token punctuation">;</span>   <span class="token comment">/* Combination of METH_xxx flags, which mostly</pre></td></tr><tr><td data-num="5"></td><td><pre>                               describe the args expected by the C func */</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span>  <span class="token operator">*</span>ml_doc<span class="token punctuation">;</span>    <span class="token comment">/* The __doc__ attribute, or NULL */</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">PyMethodDef</span> PyMethodDef<span class="token punctuation">;</span></pre></td></tr></table></figure><p>ml_meth member 是一个指向实现该方法的 C 函数指针，它的签名可以是许多签名中的一个。ml_flag 字段用于告诉 CPython 如何准确地调用该函数。</p>
<p>对于 tp_method 中的每个结构，PyType_Ready 将一个可调用对象添加到类型的字典中，此对象封装了结构，当我们调用它时，调用由 ml_meth 指向的函数。这基本上就是 C 函数如何称为 Python 类型方法的过程。</p>
<h4 id="tp_member"><a class="markdownIt-Anchor" href="#tp_member">#</a> tp_member</h4>
<p>tp_member slot 是 PyMemberDef 结构的数组。每个结构描述一个属性，该属性公开该类型对象的一个 C 成员：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">PyMemberDef</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">int</span> type<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    Py_ssize_t offset<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> flags<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>doc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> PyMemberDef<span class="token punctuation">;</span></pre></td></tr></table></figure><p>成员由偏移量指定，其类型由类型指定。</p>
<p>对于 tp_member 中的每个结构，PyType_Ready 将一个成员描述符添加到类型的字典中。成员描述符是封装 PyMemberDef 的数据描述法。它的 tp_descr_get 接受一个实例，找到位于偏移位置的实例的成员，将其转换为相应的 Python 对象并返回。它的 tp_descr_set 接受一个实例和一个值，找到位于偏移量的实例的成员，并将其设置为该值的 C 等价物。可以通过 flag 指定成员是否可读可写</p>
<p>例如通过这种机制，type 定义__dictoffset__和其他成员：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> PyMemberDef type_members<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__basicsize__"</span><span class="token punctuation">,</span> T_PYSSIZET<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span>tp_basicsize<span class="token punctuation">)</span><span class="token punctuation">,</span>READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__itemsize__"</span><span class="token punctuation">,</span> T_PYSSIZET<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_itemsize<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__flags__"</span><span class="token punctuation">,</span> T_ULONG<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_flags<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__weakrefoffset__"</span><span class="token punctuation">,</span> T_PYSSIZET<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_weaklistoffset<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__base__"</span><span class="token punctuation">,</span> T_OBJECT<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_base<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__dictoffset__"</span><span class="token punctuation">,</span> T_PYSSIZET<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_dictoffset<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__mro__"</span><span class="token punctuation">,</span> T_OBJECT<span class="token punctuation">,</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>PyTypeObject<span class="token punctuation">,</span> tp_mro<span class="token punctuation">)</span><span class="token punctuation">,</span> READONLY<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="tp_getset"><a class="markdownIt-Anchor" href="#tp_getset">#</a> tp_getset</h4>
<p>tp_getset 是 PyGetSetDef 结构的数组，它描述任意的数据描述符，如 property：</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">PyGetSetDef</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    getter get<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    setter set<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>doc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">void</span> <span class="token operator">*</span>closure<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span> PyGetSetDef<span class="token punctuation">;</span></pre></td></tr></table></figure><p>对于 tp_getset 中的每个结构，PyType_Ready 将一个 getset 描述符添加到类型的字典中，getset 描述符的 tp_descr_get 指定 get 函数，tp_descr_set 指定 set 函数。</p>
<p>类型使用这种机制定义__dict__属性</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> PyGetSetDef func_getsetlist<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__code__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_code<span class="token punctuation">,</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_code<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__defaults__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_defaults<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_defaults<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__kwdefaults__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_kwdefaults<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_kwdefaults<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__annotations__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_annotations<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_annotations<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__dict__"</span><span class="token punctuation">,</span> PyObject_GenericGetDict<span class="token punctuation">,</span> PyObject_GenericSetDict<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__name__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_name<span class="token punctuation">,</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_name<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token string">"__qualname__"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>getter<span class="token punctuation">)</span>func_get_qualname<span class="token punctuation">,</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span>func_set_qualname<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span><span class="token constant">NULL</span><span class="token punctuation">&#125;</span> <span class="token comment">/* Sentinel */</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>__dict__属性不是作为只读成员描述符实现，而是作为 getset 描述符实现，因为它不仅仅返回位于 tp_dictoffset 的字典。例如描述符创建字典（如果它还不存在）</p>
<p>类还通过这种机制获取__dict__属性。创建类的 type_new 函数在调用 PyType_Ready 之前指定 tp_getset。但是有些类没有这个属性，因为它们的实例没有字典，这些是定义了__slots__的类</p>
<h4 id="__slots__"><a class="markdownIt-Anchor" href="#__slots__">#</a> __slots__</h4>
<p>类的__slots__属性枚举该类可以拥有的属性</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> class D:</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span>.     __slots__ <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'x'</span>, <span class="token string">'y'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">..</span>.</pre></td></tr></table></figure><p>如果一个类定义了__slots__，那么__dict__属性将不会被添加到类的字典中，并且该类的 tp_dictoffset 被设置为 0。这样做的主要结果是实例没有字典</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> D.__dictoffset__</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token number">0</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> d <span class="token operator">=</span> D<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> d.__dict__</pre></td></tr><tr><td data-num="5"></td><td><pre>Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:</pre></td></tr><tr><td data-num="6"></td><td><pre>  File <span class="token string">"&lt;stdin>"</span>, line <span class="token number">1</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>AttributeError: <span class="token string">'D'</span> object has no attribute <span class="token string">'__dict__'</span></pre></td></tr></table></figure><p>但是__slots__中列出的属性可以正常的工作</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> d.x <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> d.x</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">1</span></pre></td></tr></table></figure><p>会发现很奇怪，定义在__slots__的成员成为了类实例的成员。对于每个成员，成员描述符被添加到类字典中。type_new 函数指定 tp_memeber 执行此操作。</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">>></span><span class="token operator">></span> D.x</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>member <span class="token string">'x'</span> of <span class="token string">'D'</span> objects<span class="token operator">></span></pre></td></tr></table></figure><p>你会发现 x、y 是一个 member object。实例没有字典，所以__slots__可以节省内存。</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9ob3d0by9kZXNjcmlwdG9yLmh0bWwjbWVtYmVyLW9iamVjdHMtYW5kLXNsb3Rz">Descriptor HowTo Guide</span></p>
</blockquote>
<p>编译器生成 LOAD_ATTR、STORE_ATTR 和 DELETE_ATTR 操作码以获取、设置和删除属性。为了执行这些操作码，VM 调用对象类型的 tp_getattro 和 tp_setattro slot，一个类型可能以任意的方式实现这些 slot，但大多数情况下我们必须处理三个实现：</p>
<ul>
<li>大多数内置类型和类使用的泛型实现</li>
<li>按类型使用的实现</li>
<li>定义__getattribute__、__getattr__、__setattr__和__delattr__魔法方法的类所使用的实现</li>
</ul>
<p>简而言之，描述符是控制属性访问、分配和删除的属性。它允许 CPython 实现许多特性，包括方法和属性。</p>
<p>内置类型使用三种机制定义属性：</p>
<ul>
<li>tp_methods</li>
<li>tp_members</li>
<li>tp_getset</li>
</ul>
<p>类还是用这些机制来定义一些属性，比如__dict__被定义为一个 getset 描述符，而__slots__中定义的属性被定义为成员描述符。</p>
<div align=center width=100%><iframe class="video-frame" height=500 width=80% frameborder=0 allowfullscreen src="//player.bilibili.com/player.html?aid=218281849&bvid=BV178411b7RG&cid=838896190&page=1" ></iframe></div>

      <div class="tags">
          <a href="/tags/CPython/" rel="tag"><i class="ic i-tag"></i> CPython</a>
          <a href="/tags/C/" rel="tag"><i class="ic i-tag"></i> C</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-11-04 21:37:53" itemprop="dateModified" datetime="2022-11-04T21:37:53+08:00">2022-11-04</time>
  </span>
  <span id="2022/11/02/Python的属性是如何工作的/" class="item leancloud_visitors" data-flag-title="Python的属性是如何工作的" title="Views">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">Views</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">times</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="小芳芳 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="小芳芳 Alipay">
        <p>Alipay</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>石理一淡 <i class="ic i-at"><em>@</em></i>士多啤梨苹果橙
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/" title="Python的属性是如何工作的">http://example.com/2022/11/02/Python的属性是如何工作的/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/10/25/PPT%E7%BB%93%E6%9E%84%E7%BB%84%E6%88%90%EF%BC%88%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E6%80%BB%E7%BB%93%EF%BC%89/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giph4lm9i7j20zk0m84qp.jpg" title="PPT结构组成（工作中的总结）">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> PowerPoint</span>
  <h3>PPT结构组成（工作中的总结）</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/11/04/%E6%81%90%E9%AC%BC%E7%97%87%E5%8D%95%E9%80%9A-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9A%BE%E5%BA%A6-%E6%97%A0%E8%BA%B2%E8%97%8F%E7%82%B9/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s3.bmp.ovh&#x2F;imgs&#x2F;2022&#x2F;11&#x2F;04&#x2F;dca8e5d18cf0e11b.webp" title="恐鬼症单通 自定义难度 无躲藏点!">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> game</span>
  <h3>恐鬼症单通 自定义难度 无躲藏点!</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text"> Python 的属性是如何工作的？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#attributes-and-the-vm"><span class="toc-number">1.0.1.</span> <span class="toc-text"> Attributes and the VM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#getting-an-attribute"><span class="toc-number">1.0.2.</span> <span class="toc-text"> Getting an attribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#setting-an-attribute"><span class="toc-number">1.0.3.</span> <span class="toc-text"> Setting an attribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deleting-an-attribute"><span class="toc-number">1.0.4.</span> <span class="toc-text"> Deleting an attribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#generic-attribute-management"><span class="toc-number">1.0.5.</span> <span class="toc-text"> Generic attribute management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#descriptors"><span class="toc-number">1.0.6.</span> <span class="toc-text"> Descriptors</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#objects-dictionary-and-types-dictionary"><span class="toc-number">1.0.7.</span> <span class="toc-text"> Object’s dictionary and type’s dictionary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pyobject_genericsetattr"><span class="toc-number">1.0.8.</span> <span class="toc-text"> PyObject_GenericSetAttr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pyobject_genericgetattr"><span class="toc-number">1.0.9.</span> <span class="toc-text"> PyObject_GenericGetAttr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metatype-attribute-management"><span class="toc-number">1.0.10.</span> <span class="toc-text"> Metatype attribute management</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#type_setattro"><span class="toc-number">1.0.10.1.</span> <span class="toc-text"> type_setattro</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type_getattro"><span class="toc-number">1.0.10.2.</span> <span class="toc-text"> type_getattro</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#custom-attribute-management"><span class="toc-number">1.0.11.</span> <span class="toc-text"> Custom attribute management</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loading-methods"><span class="toc-number">1.0.12.</span> <span class="toc-text"> Loading methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#listing-attributes-of-an-object"><span class="toc-number">1.0.13.</span> <span class="toc-text"> Listing attributes of an object</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#where-attributes-of-types-come-from"><span class="toc-number">1.0.14.</span> <span class="toc-text"> Where attributes of types come from</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tp_method"><span class="toc-number">1.0.14.1.</span> <span class="toc-text"> tp_method</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tp_member"><span class="toc-number">1.0.14.2.</span> <span class="toc-text"> tp_member</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#tp_getset"><span class="toc-number">1.0.14.3.</span> <span class="toc-text"> tp_getset</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#__slots__"><span class="toc-number">1.0.14.4.</span> <span class="toc-text"> __slots__</span></a></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/06/06/%E5%93%AA%E4%BA%9BPython%E6%93%8D%E4%BD%9C%E6%98%AFatomic%E7%9A%84%EF%BC%9F/" rel="bookmark" title="哪些Python操作是atomic的？">哪些Python操作是atomic的？</a></li><li><a href="/2022/06/08/Python%E5%86%85%E7%BD%AEgetattr%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="getattr實現原理">getattr實現原理</a></li><li><a href="/2022/06/13/Python%20tuple%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python Tuple實現原理">Python Tuple實現原理</a></li><li><a href="/2022/06/22/Python%20range%E7%9A%84%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python range的實現原理">Python range的實現原理</a></li><li><a href="/2022/06/23/CPython-VM%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/" rel="bookmark" title="CPython VM的工作原理">CPython VM的工作原理</a></li><li><a href="/2022/06/28/Python%20map%E5%AF%B9%E8%B1%A1%E6%8E%A2%E7%A9%B6/" rel="bookmark" title="Python map对象探究">Python map对象探究</a></li><li><a href="/2022/07/06/Python%20zip%E5%86%85%E7%BD%AE%E7%B1%BB%E7%9A%84%E8%83%8C%E5%90%8E%E6%9C%BA%E5%88%B6/" rel="bookmark" title="Python zip内置类的背后机制">Python zip内置类的背后机制</a></li><li><a href="/2022/08/03/Python%20list%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" rel="bookmark" title="Python list实现原理">Python list实现原理</a></li><li><a href="/2022/08/12/Python%20Property%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="bookmark" title="Property源码分析">Property源码分析</a></li><li class="active"><a href="/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/" rel="bookmark" title="Python的属性是如何工作的">Python的属性是如何工作的</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="小芳芳"
      data-src="/images/avatar.png">
  <p class="name" itemprop="name">小芳芳</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">14</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">9</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">8</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL0NMQVktemhhbw==" title="https:&#x2F;&#x2F;github.com&#x2F;CLAY-zhao"><i class="ic i-github"></i></span>
      <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMjkxMzUwNTA=" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;29135050"><i class="ic i-bilibili"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/10/25/PPT%E7%BB%93%E6%9E%84%E7%BB%84%E6%88%90%EF%BC%88%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E6%80%BB%E7%BB%93%EF%BC%89/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/11/04/%E6%81%90%E9%AC%BC%E7%97%87%E5%8D%95%E9%80%9A-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9A%BE%E5%BA%A6-%E6%97%A0%E8%BA%B2%E8%97%8F%E7%82%B9/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/Python/" title="In Python">Python</a>
</div>

    <span><a href="/2022/06/22/Python%20range%E7%9A%84%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" title="Python range的實現原理">Python range的實現原理</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Office/" title="In Office">Office</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Office/PowerPoint/" title="In PowerPoint">PowerPoint</a>
</div>

    <span><a href="/2022/10/25/PPT%E7%BB%93%E6%9E%84%E7%BB%84%E6%88%90%EF%BC%88%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E6%80%BB%E7%BB%93%EF%BC%89/" title="PPT结构组成（工作中的总结）">PPT结构组成（工作中的总结）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/11/02/Python%E7%9A%84%E5%B1%9E%E6%80%A7%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84/" title="Python的属性是如何工作的">Python的属性是如何工作的</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/08/12/Python%20Property%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Property源码分析">Property源码分析</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Python/" title="In Python">Python</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Python/Django/" title="In Django">Django</a>
</div>

    <span><a href="/2022/10/19/Python%20Django%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%97%B6%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88/" title="Python Django服务启动时做了什么?">Python Django服务启动时做了什么?</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/06/08/Python%E5%86%85%E7%BD%AEgetattr%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" title="getattr實現原理">getattr實現原理</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/game/" title="In game">game</a>
</div>

    <span><a href="/2022/11/04/%E6%81%90%E9%AC%BC%E7%97%87%E5%8D%95%E9%80%9A-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9A%BE%E5%BA%A6-%E6%97%A0%E8%BA%B2%E8%97%8F%E7%82%B9/" title="恐鬼症单通 自定义难度 无躲藏点!">恐鬼症单通 自定义难度 无躲藏点!</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/06/06/%E5%93%AA%E4%BA%9BPython%E6%93%8D%E4%BD%9C%E6%98%AFatomic%E7%9A%84%EF%BC%9F/" title="哪些Python操作是atomic的？">哪些Python操作是atomic的？</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Life/" title="In Life">Life</a>
</div>

    <span><a href="/2022/06/03/%E7%AB%AF%E5%8D%88%E8%8A%82%E5%BF%AB%E4%B9%90/" title="端午节快乐">端午节快乐</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CPython/" title="In CPython">CPython</a>
<i class="ic i-angle-right"></i>
<a href="/categories/CPython/C/" title="In C">C</a>
</div>

    <span><a href="/2022/06/13/Python%20tuple%E5%AF%A6%E7%8F%BE%E5%8E%9F%E7%90%86/" title="Python Tuple實現原理">Python Tuple實現原理</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">小芳芳 @ Leayoos Chui</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/11/02/Python的属性是如何工作的/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
